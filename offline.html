<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impostor F√∫tbol ‚Äì Offline</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --blue-900:#071730; --blue-800:#0b254b; --blue-700:#123563; --blue-600:#1b4a86;
    --panel:#0f2b4b; --panel-2:#0c213a; --accent:#3b82f6; --accent-2:#60a5fa;
    --yellow:#f6c11b; --yellow-2:#f39c12; --text:#eaf2ff; --muted:#a7c0e8; --success:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    background: radial-gradient(1200px 420px at 15% 8%, rgba(61,126,217,.20) 0, transparent 60%),
                radial-gradient(1200px 420px at 85% 8%, rgba(61,126,217,.20) 0, transparent 60%),
                #0a1a2f;
    background-attachment: fixed; background-size: cover; overflow:hidden;
  }
  body.has-bg{
    background-image: url("fondo-favela.webp");
    background-position: center; background-repeat: no-repeat;
    background-size: cover; background-attachment: fixed;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background:
      radial-gradient(1200px 420px at 15% 8%, rgba(61,126,217,.35) 0%, transparent 60%),
      radial-gradient(1200px 420px at 85% 8%, rgba(61,126,217,.35) 0%, transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.25) 40%, rgba(0,0,0,.45));
    pointer-events:none; z-index:-1;
  }
  .container{ width:min(1200px,92vw); margin:0 auto; padding:20px 0 28px; display:flex; flex-direction:column; gap:18px }

  /* Header */
  .room-card{
    background: linear-gradient(180deg, rgba(7,28,56,.9), rgba(8,33,63,.88));
    border:1.5px solid rgba(128,180,255,.25); border-radius:16px;
    box-shadow: 0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    padding:16px 18px; display:flex; align-items:center; gap:16px; justify-content:space-between;
  }
  .brand{ display:flex; align-items:center; gap:12px; white-space:nowrap }
  .brand .ball{
    width:44px; height:44px; border-radius:50%;
    background:
      radial-gradient(circle at 50% 50%, #fff 0 48%, transparent 50%),
      conic-gradient(#111 0 60deg, #fff 0 120deg, #111 0 180deg, #fff 0 240deg, #111 0 300deg, #fff 0 360deg);
    box-shadow:0 0 14px rgba(255,255,255,.35);
  }
  .brand h1{ margin:0; letter-spacing:.5px; line-height:1; font-size:28px; font-weight:800; text-transform:uppercase; text-shadow: 0 3px 0 rgba(0,0,0,.5) }
  .brand h1 span{ color:#7cf062 }

  .offline-badge{
    display:flex; align-items:center; gap:10px;
    background: linear-gradient(180deg, #0c2747, #0a213b);
    border:1px solid rgba(128,180,255,.28);
    border-radius:12px; padding:10px 14px; font-weight:800;
  }
  .offline-dot{ width:10px; height:10px; border-radius:50%; background:#f87171; box-shadow:0 0 0 3px rgba(248,113,113,.25) }
  .offline-sub{ font-size:12px; font-weight:600; color:#cfe2ff; opacity:.85 }

  /* Jugadores */
  .players{ display:grid; grid-template-columns: repeat(8, 1fr); gap:16px; padding:0 4px }
  .player{
    background: linear-gradient(180deg, rgba(14,39,70,.9), rgba(10,30,53,.85));
    border:1px solid rgba(128,180,255,.25); border-radius:16px;
    padding:10px 8px; display:flex; flex-direction:column; align-items:center; gap:8px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05); min-height:108px;
  }
  .avatar{ width:56px; height:56px; border-radius:50%;
    background:
      radial-gradient(36px 24px at 50% 30%, #ffd6b4 0 60%, #e9b089 61% 100%),
      radial-gradient(80px 40px at 50% 105%, #222 0 60%, transparent 61%),
      linear-gradient(180deg, #e23a3a, #a61e1e);
    box-shadow:0 3px 10px rgba(0,0,0,.35), 0 0 0 3px rgba(255,255,255,.06) inset;
    transition:.15s ease;
  }
  .avatar:hover{ transform:scale(1.05); filter:brightness(1.15); cursor:pointer; }
  .avatar.placeholder{
    background: radial-gradient(28px 28px at 50% 40%, #2f4b73 0 60%, #203a5e 61% 100%),
                radial-gradient(48px 48px at 50% 110%, #162b4a 0 58%, transparent 59%);
    filter: saturate(.9);
  }
  .player small{ color:var(--muted); font-weight:600; letter-spacing:.2px }

  /* Settings */
  .settings{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:18px; margin-top:6px }
  .card{
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(128,180,255,.25); border-radius:16px;
    padding:14px; box-shadow: 0 8px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .card h3{ margin:0 0 8px; font-size:16px; letter-spacing:.3px; color:#cce0ff; text-transform:uppercase; font-weight:800 }
  .selector{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    background: linear-gradient(180deg, #0b2441, #0a213b);
    border:1px solid rgba(128,180,255,.28); border-radius:12px; padding:10px 10px;
  }
  .selector .value{ font-size:28px; font-weight:800; letter-spacing:.6px }
  .selector .arrow{
    width:40px; height:40px; border-radius:10px;
    background: linear-gradient(180deg, #1e68d6, #184fa5);
    border:1px solid rgba(110,178,255,.7);
    box-shadow: 0 6px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.1);
    display:grid; place-items:center; cursor:pointer; user-select:none; font-size:20px; font-weight:900;
  }
  .selector .arrow:active{ transform:translateY(1px) }

  /* CTA */
  .cta{ margin-top:8px; display:flex; justify-content:center }
  .btn-cta{
    background: linear-gradient(180deg, var(--yellow), var(--yellow-2));
    border:1px solid rgba(255,210,80,.9); color:#10223b; font-weight:900; letter-spacing:.6px; font-size:28px;
    padding:16px 34px; border-radius:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,.45), inset 0 1px 0 #fff4c2; cursor:pointer; transition:transform .04s ease, filter .12s ease;
  }
  .btn-cta:hover{ filter:brightness(1.05) }
  .btn-cta:active{ transform:translateY(1px) }

  .row{ display:flex; align-items:center; gap:10px }
  .spacer{ flex:1 }

  @media (max-width: 980px){
    .players{ grid-template-columns: repeat(4, 1fr) }
    .settings{ grid-template-columns: 1fr; }
    body{ overflow:auto }
  }

  /* ===== Overlay base ===== */
  .overlay{
    position:fixed; inset:0; z-index:1000; display:none; place-items:center;
    background: radial-gradient(1200px 420px at 15% 8%, rgba(61,126,217,.35) 0%, transparent 60%),
                radial-gradient(1200px 420px at 85% 8%, rgba(61,126,217,.35) 0%, transparent 60%),
                rgba(0,10,20,.9);
    padding:16px;
  }

  /* ===== Tarjeta de rol con flip ===== */
  .role-card{
    width:min(720px, 96vw);
    background: linear-gradient(180deg, #0d2747, #0b203a);
    border:1px solid rgba(128,180,255,.30); border-radius:20px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
    padding: clamp(14px, 2.5vw, 24px);
    text-align:center; perspective:1200px;
  }
  .role-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .rev-title{margin:0; font-weight:900; letter-spacing:.5px; font-size: clamp(20px, 3vw, 28px)}
  .rev-step{opacity:.8; font-size:12px; color:#cfe2ff}

  .role-body{
    position:relative; border-radius:16px; overflow:hidden;
    background: linear-gradient(180deg, #102c4f, #0c2441);
    border:1px solid rgba(128,180,255,.25);
    min-height: clamp(140px, 28vw, 220px);
    transform-style: preserve-3d; transition: transform .5s ease;
  }
  .face{position:absolute; inset:0; display:grid; place-items:center; padding:16px; backface-visibility:hidden}
  .front{gap:12px}
  .back{transform: rotateY(180deg); gap:10px}
  .role-card.revealed .role-body{ transform: rotateY(180deg) }

  .hint{opacity:.85; font-size: clamp(12px, 2.4vw, 14px)}
  .secret-word{
    font-weight:900; font-size: clamp(24px, 5.5vw, 40px); color:#7cf062;
    text-shadow: 0 2px 0 rgba(0,0,0,.5); padding: 2px 8px;
  }
  .role-sub{opacity:.8; margin:0; font-size: clamp(12px, 2.6vw, 14px)}
  .role-badge{
    font-weight:900; letter-spacing:.6px;
    padding:6px 10px; border-radius:999px; width:max-content; margin:0 auto 6px;
    font-size: clamp(12px, 2.6vw, 14px);
    background: linear-gradient(180deg,#1e68d6,#184fa5);
    border:1px solid rgba(110,178,255,.7); color:#eaf2ff;
  }
  .role-card.is-imp .role-badge{
    background: linear-gradient(180deg,#ff6b6b,#ea4335);
    border-color: rgba(255,179,172,.85); color:#111;
  }
  .role-card.is-imp .secret-word{ display:none }
  .role-card.is-civ .role-badge{
    background: linear-gradient(180deg,#22c55e,#16a34a);
    border-color: rgba(152,255,190,.85); color:#08260f
  }

  .rev-actions{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:14px }
  .btn-ghost{
    background: linear-gradient(180deg, #142840, #0f2237);
    border:1px solid rgba(128,180,255,.35); color:#cfe2ff; font-weight:700;
    padding:12px 16px; border-radius:12px; cursor:pointer;
  }
  .btn-primary{
    background: linear-gradient(180deg, #1e68d6, #184fa5);
    border:1px solid rgba(110,178,255,.7); color:#eaf2ff; font-weight:800;
    padding:12px 18px; border-radius:12px; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.45);
  }
  .btn-cta.small{ font-size:18px; padding:10px 16px }

  /* TIMER & VOTE (iguales a tu versi√≥n) */
  #timerOverlay{
    position:fixed; inset:0; z-index:1100; display:none; place-items:center;
    background: radial-gradient(1000px 360px at 20% 10%, rgba(255,255,255,.08), transparent 60%), rgba(0,10,20,.92);
  }
  .timer-card{
    width:min(520px,92vw);
    background: linear-gradient(180deg,#0d2747,#0b203a);
    border:1px solid rgba(128,180,255,.30); border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.6); padding:24px; text-align:center;
  }
  .timer-big{ font-size:84px; font-weight:900; letter-spacing:2px; margin:6px 0 0 }
  .timer-sub{ opacity:.85; margin:0 0 8px }

  #voteOverlay{ position:fixed; inset:0; z-index:1200; display:none; background: rgba(0,10,20,.92); padding:20px; }
  .vote-wrap{
    width:min(1100px,96vw); margin:0 auto; background: linear-gradient(180deg,#0d2747,#0b203a);
    border:1px solid rgba(128,180,255,.30); border-radius:18px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.6);
  }
  .vote-grid{ display:grid; gap:12px; margin-top:10px; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); }
  .vote-card{
    background: linear-gradient(180deg,#0f2b4b,#0c213a); border:1px solid rgba(128,180,255,.25); border-radius:14px;
    padding:12px; display:flex; flex-direction:column; align-items:center; gap:10px; cursor:pointer; user-select:none;
  }
  .vote-card .circle{ width:64px; height:64px; border-radius:50%; background:linear-gradient(180deg,#1e68d6,#184fa5) }
  .vote-card .name{ font-weight:800 }
  .vote-card .count{ font-size:14px; opacity:.9 }
  .vote-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
  .btn-danger{
    background: linear-gradient(180deg,#ff6b6b,#ea4335);
    border:1px solid rgba(255,179,172,.75); color:#111; font-weight:900;
    padding:10px 16px; border-radius:12px; cursor:pointer;
  }
</style>
<link rel="preload" as="image" href="fondo-favela.webp" fetchpriority="high">
</head>
<body>

  <div class="container">
    <!-- Header -->
    <div class="room-card">
      <div class="brand">
        <div class="ball" aria-hidden="true"></div>
        <h1>Impostor <span>F√∫tbol</span></h1>
      </div>
      <div class="offline-badge" title="Todos juegan en el mismo dispositivo">
        <span class="offline-dot" aria-hidden="true"></span>
        <div>
          Modo <b>Offline</b>
          <div class="offline-sub">Mismo dispositivo ‚Äì sin internet</div>
        </div>
      </div>
    </div>

    <!-- Jugadores -->
    <div class="players" id="players"></div>

    <!-- Configuraci√≥n -->
    <div class="settings">
      <div class="card">
        <h3>Impostores</h3>
        <div class="selector">
          <div class="arrow" data-dec="impostores">‚Äπ</div>
          <div class="value" id="impostoresVal">1</div>
          <div class="arrow" data-inc="impostores">‚Ä∫</div>
        </div>
      </div>

      <div class="card">
        <h3>Jugadores</h3>
        <div class="selector">
          <div class="arrow" data-dec="jugadores">‚Äπ</div>
          <div class="value" id="jugadoresVal">8</div>
          <div class="arrow" data-inc="jugadores">‚Ä∫</div>
        </div>
      </div>

      <div class="card">
        <h3>Tema</h3>
        <div class="selector">
          <div class="arrow" data-dec="tema">‚Äπ</div>
          <div class="value" id="temaVal">Clubes</div>
          <div class="arrow" data-inc="tema">‚Ä∫</div>
        </div>
      </div>

      <div class="card">
        <h3>Tiempo de ronda</h3>
        <div class="selector">
          <div class="arrow" data-dec="tiempo">‚Äπ</div>
          <div class="value" id="tiempoVal">60s</div>
          <div class="arrow" data-inc="tiempo">‚Ä∫</div>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="cta">
      <button class="btn-cta" id="startBtn">EMPEZAR PARTIDA</button>
    </div>
  </div>

  <!-- Overlay REVELACI√ìN (sin hold) -->
  <div id="reveal" class="overlay">
    <div id="roleCard" class="role-card">
      <header class="role-head">
        <h2 id="revTitle" class="rev-title">Jugador 1</h2>
        <div class="rev-step" id="revStep"></div>
      </header>

      <div class="role-body">
        <!-- Frente -->
        <div class="face front" id="frontFace">
          <div class="hint">Toc√° ‚ÄúMostrar‚Äù para ver tu rol</div>
          <button id="btnMostrar" class="btn-primary">üëÅÔ∏è Mostrar</button>
        </div>

        <!-- Dorso -->
        <div class="face back" id="backFace">
          <div id="roleBadge" class="role-badge">CIVIL</div>
          <p id="roleSub" class="role-sub">Palabra secreta (Clubes)</p>
          <div id="secretWord" class="secret-word">Real Madrid</div>
        </div>
      </div>

      <footer class="rev-actions">
        <button id="btnOcultar" class="btn-ghost" style="display:none">üôà Ocultar</button>
        <button id="btnSiguiente" class="btn-primary" style="display:none">üëâ Pasar al siguiente</button>
        <button id="btnComenzarRonda" class="btn-cta small" style="display:none">üöÄ Comenzar ronda</button>
      </footer>
    </div>
  </div>

  <!-- Overlay TIMER -->
  <div id="timerOverlay"><div class="timer-card">
    <p class="timer-sub">Tiempo de la ronda</p>
    <div id="timerText" class="timer-big">01:00</div>
  </div></div>

  <!-- Overlay VOTACI√ìN -->
  <div id="voteOverlay">
    <div class="vote-wrap">
      <h2 style="margin:0;font-weight:900">Votaci√≥n</h2>
      <p style="margin:6px 0 0;opacity:.85">Toquen para acusar. Luego cerr√° la votaci√≥n para ver el resultado.</p>
      <div id="voteGrid" class="vote-grid"></div>
      <div class="vote-actions">
        <button id="clearVotes" class="btn-ghost">Limpiar votos</button>
        <div class="spacer"></div>
        <button id="closeVote" class="btn-cta small">Cerrar votaci√≥n</button>
      </div>
    </div>
  </div>

<script>
/* ===== Estado general ===== */
const state = {
  impostores: 1,         // 1‚Äì3
  jugadores: 8,          // 4‚Äì10
  temas: ["Clubes","Jugadores","Mundiales"],
  temaIndex: 0,
  tiempos: [30,45,60,90], // segundos
  tiempoIndex: 2          // por defecto 60s
};

// === Nombres offline (por slot 1..N) ===
const NAMES_KEY = "offlineNames:v1";
let offlineNames = {};
try{ offlineNames = JSON.parse(localStorage.getItem(NAMES_KEY)) || {}; }catch{ offlineNames = {}; }

function getName(slot){
  const s = (offlineNames[slot] || "").trim();
  return s ? s : `Jugador ${slot}`;
}
function setName(slot, name){
  offlineNames[slot] = name;
  localStorage.setItem(NAMES_KEY, JSON.stringify(offlineNames));
}

const $ = s => document.querySelector(s);
const impostoresEl = $("#impostoresVal");
const jugadoresEl  = $("#jugadoresVal");
const temaEl       = $("#temaVal");
const tiempoEl     = $("#tiempoVal");

function render(){
  impostoresEl.textContent = state.impostores;
  jugadoresEl.textContent  = state.jugadores;
  temaEl.textContent       = state.temas[state.temaIndex];
  tiempoEl.textContent     = state.tiempos[state.tiempoIndex] + "s";

  const wrap = $("#players");

  // Ajustar cantidad de tarjetas visibles
  while (wrap.children.length > state.jugadores) wrap.removeChild(wrap.lastElementChild);
  while (wrap.children.length < state.jugadores){
    const i = wrap.children.length + 1;
    const card = document.createElement("div");
    card.className = "player";
    card.innerHTML = `
      <div class="avatar ${i===1?'':'placeholder'}" data-slot="${i}" title="Tocar para cambiar nombre"></div>
      <small class="pname">${getName(i)}</small>`;
    wrap.appendChild(card);
  }

  // Actualizar nombres y enganchar edici√≥n por avatar
  Array.from(wrap.children).forEach((card, idx)=>{
    const slot = idx + 1;
    const nameSpan = card.querySelector(".pname");
    if (nameSpan) nameSpan.textContent = getName(slot);
  });

  wrap.querySelectorAll(".avatar[data-slot]").forEach(avatar=>{
    avatar.onclick = ()=>{
      const slot = Number(avatar.dataset.slot);
      const prev = getName(slot);
      const nuevo = prompt(`Nombre para el jugador ${slot} (2‚Äì16 caracteres):`, prev) ?? "";
      const v = nuevo.trim();
      if(v.length < 2 || v.length > 16) return;
      setName(slot, v);
      render();
    };
  });
}

/* ===== Selectores (flechas) ===== */
document.querySelectorAll(".arrow").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const incKey = btn.dataset.inc, decKey = btn.dataset.dec;
    if(incKey==="impostores") state.impostores = Math.min(3, state.impostores+1);
    if(decKey==="impostores") state.impostores = Math.max(1, state.impostores-1);
    if(incKey==="jugadores")  state.jugadores  = Math.min(10, state.jugadores+1);
    if(decKey==="jugadores")  state.jugadores  = Math.max(4, state.jugadores-1);
    if(incKey==="tema")       state.temaIndex  = (state.temaIndex+1)%state.temas.length;
    if(decKey==="tema")       state.temaIndex  = (state.temaIndex-1+state.temas.length)%state.temas.length;
    if(incKey==="tiempo")     state.tiempoIndex= (state.tiempoIndex+1)%state.tiempos.length;
    if(decKey==="tiempo")     state.tiempoIndex= (state.tiempoIndex-1+state.tiempos.length)%state.tiempos.length;
    if(state.impostores >= state.jugadores) state.impostores = Math.max(1, state.jugadores-1);
    render();
  });
});

/* ===== Pools por tema ===== */
const POOLS = {
  "Clubes": ["Real Madrid","Barcelona","Boca Juniors","River Plate","PSG","Manchester City","Inter","AC Milan","Liverpool","Chelsea"],
  "Jugadores": ["Lionel Messi","Cristiano Ronaldo","Diego Maradona","Pel√©","Kylian Mbapp√©","Erling Haaland","Neymar","Zinedine Zidane","Ronaldinho","Ronaldo Naz√°rio"],
  "Mundiales": ["Mundial 2002","Mundial 2006","Mundial 2010","Mundial 2014","Mundial 2018","Mundial 2022"]
};

/* ===== Utilidades ===== */
const randInt=n=>Math.floor(Math.random()*n);
const sampleOne=arr=>arr[randInt(arr.length)];
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=randInt(i+1); [a[i],a[j]]=[a[j]]=[a[i],a[j]]}return a} // safe
function pickKUnique(k,n){const idx=Array.from({length:n},(_,i)=>i);shuffle(idx);return idx.slice(0,k)}

/* ===== REVEAL (sin hold) ===== */
let assignments=[];   // {player, name, role, word, tema}
let currentReveal=0;

const $reveal       = document.getElementById("reveal");
const $roleCard     = document.getElementById("roleCard");
const $revTitle     = document.getElementById("revTitle");
const $revStep      = document.getElementById("revStep");
const $btnMostrar   = document.getElementById("btnMostrar");
const $btnOcultar   = document.getElementById("btnOcultar");
const $btnSiguiente = document.getElementById("btnSiguiente");
const $btnComenzar  = document.getElementById("btnComenzarRonda");
const $roleBadge    = document.getElementById("roleBadge");
const $roleSub      = document.getElementById("roleSub");
const $secretWord   = document.getElementById("secretWord");

function abrirOverlay(){ $reveal.style.display="grid"; }
function cerrarOverlay(){ $reveal.style.display="none"; }

function prepararPantallaReveal(){
  const a = assignments[currentReveal];
  $revTitle.textContent = a.name || `Jugador ${a.player}`;
  $revStep.textContent  = `Jugador ${currentReveal+1} de ${assignments.length}`;

  $roleCard.className = "role-card"; // reset
  if(a.role === "IMPOSTOR"){
    $roleCard.classList.add("is-imp");
    $roleBadge.textContent = "IMPOSTOR";
    $roleSub.textContent   = "No conoc√©s la palabra";
    $secretWord.textContent = "";
  }else{
    $roleCard.classList.add("is-civ");
    $roleBadge.textContent = "CIVIL";
    $roleSub.textContent   = `Palabra secreta (${a.tema})`;
    $secretWord.textContent = a.word || "‚Äî";
  }

  // Estado de botones/flip
  $roleCard.classList.remove("revealed");
  $btnMostrar.style.display   = "";
  $btnOcultar.style.display   = "none";
  $btnSiguiente.style.display = "none";
  $btnComenzar.style.display  = "none";
}

$btnMostrar.addEventListener("click", ()=>{
  $roleCard.classList.add("revealed");
  $btnMostrar.style.display = "none";
  $btnOcultar.style.display = "";
  $btnSiguiente.style.display = (currentReveal < assignments.length-1) ? "" : "none";
  $btnComenzar.style.display  = (currentReveal === assignments.length-1) ? "" : "none";
});
$btnOcultar.addEventListener("click", ()=>{
  $roleCard.classList.remove("revealed");
  $btnMostrar.style.display = "";
  $btnOcultar.style.display = "none";
  $btnSiguiente.style.display = "none";
  $btnComenzar.style.display  = "none";
});
$btnSiguiente.addEventListener("click", ()=>{
  if(currentReveal<assignments.length-1){
    currentReveal++;
    prepararPantallaReveal();
  }
});

$btnComenzar.addEventListener("click", ()=>{
  cerrarOverlay();
  const secs = state.tiempos[state.tiempoIndex];
  startTimer(secs);
});

function iniciarPartida(){
  const N=state.jugadores, K=state.impostores, tema=state.temas[state.temaIndex];
  if(K>=N){ alert("Impostores debe ser menor que jugadores."); return; }
  const palabra = sampleOne(POOLS[tema]||["Bal√≥n"]);
  const impostores = new Set(pickKUnique(K,N));
  assignments=[];
  for(let i=0;i<N;i++){
    const slot = i+1;
    const isImp = impostores.has(i);
    assignments.push({
      player: slot,
      name: getName(slot),
      role: isImp ? "IMPOSTOR" : "CIVIL",
      word: isImp ? null : palabra,
      tema
    });
  }
  currentReveal=0;
  abrirOverlay();
  prepararPantallaReveal();
}

/* ===== Timer y Votaci√≥n ===== */
const $timerOverlay=$("#timerOverlay"), $timerText=$("#timerText");
let timerId=null, remaining=0;

function formatTime(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}` }

function startTimer(seconds){
  remaining = seconds;
  $timerText.textContent = formatTime(remaining);
  $timerOverlay.style.display="grid";
  clearInterval(timerId);
  timerId = setInterval(()=>{
    remaining--;
    $timerText.textContent = formatTime(remaining);
    if(remaining<=0){
      clearInterval(timerId);
      $timerOverlay.style.display="none";
      openVoting();
    }
  },1000);
}

/* ===== Votaci√≥n ===== */
const $voteOverlay=$("#voteOverlay"), $voteGrid=$("#voteGrid"), $closeVote=$("#closeVote"), $clearVotes=$("#clearVotes");
let votes=[];

function openVoting(){
  const N = state.jugadores;
  votes = Array.from({length:N},()=>0);
  $voteGrid.innerHTML = "";
  for(let i=0;i<N;i++){
    const card=document.createElement("button");
    card.type="button";
    card.className="vote-card";
    card.dataset.index=i;
    card.innerHTML = `
      <div class="circle"></div>
      <div class="name">${getName(i+1)}</div>
      <div class="count" id="vcount-${i}">Votos: 0</div>`;
    card.onclick=()=>{
      votes[i]++; document.getElementById("vcount-"+i).textContent = "Votos: " + votes[i];
    };
    $voteGrid.appendChild(card);
  }
  $voteOverlay.style.display="block";
}

$clearVotes.addEventListener("click", ()=>{
  for(let i=0;i<votes.length;i++){ votes[i]=0; document.getElementById("vcount-"+i).textContent="Votos: 0"; }
});

$closeVote.addEventListener("click", ()=>{
  const max = Math.max(...votes);
  const indices = votes.map((v,i)=>[v,i]).filter(([v])=>v===max).map(([_,i])=>i);
  let msg="";
  if(max===0){
    msg="Nadie recibi√≥ votos. No hay eliminado.";
  }else if(indices.length>1){
    msg = `Empate entre: ${indices.map(i=>getName(i+1)).join(", ")} (${max} votos).`;
  }else{
    const idx = indices[0];
    const a = assignments[idx];
    msg = `El m√°s votado es <b>${a.name || ("Jugador "+(idx+1))}</b> ‚Äî <i>${a.role}</i>.`;
  }
  $voteOverlay.style.display="none";

  const result = document.createElement("div");
  result.style.cssText = "position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,10,20,.92);z-index:1300;";
  result.innerHTML = `
    <div class="timer-card">
      <h3 style="margin:0 0 8px">Resultado de la votaci√≥n</h3>
      <p style="margin:0 0 6px">${msg}</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
        <button id="resOk" class="btn-cta small">Seguir</button>
      </div>
    </div>`;
  document.body.appendChild(result);
  result.querySelector("#resOk").onclick=()=> result.remove();
});

/* Bot√≥n principal */
document.getElementById("startBtn").addEventListener("click", iniciarPartida);

/* Inicio */
render();

/* Carga de fondo */
(function(){
  const BG = "fondo-favela.webp";
  const img = new Image(); img.src = BG;
  if (img.complete) { document.body.classList.add("has-bg"); return; }
  img.onload = () => document.body.classList.add("has-bg");
})();
</script>
</body>
</html>
