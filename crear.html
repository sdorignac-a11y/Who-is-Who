<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impostor FÃºtbol â€“ Lobby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--panel:#0f2b4b;--panel-2:#0c213a;--yellow:#f6c11b;--yellow-2:#f39c12;--text:#eaf2ff;--muted:#a7c0e8}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Outfit",system-ui;color:var(--text);background:url("fondo-cancha.png") center/cover fixed no-repeat;overflow:hidden}
  .container{width:min(1200px,92vw);margin:0 auto;padding:20px 0 28px;display:flex;flex-direction:column;gap:18px}
  .room-card{background:linear-gradient(180deg,rgba(7,28,56,.9),rgba(8,33,63,.88));border:1.5px solid rgba(128,180,255,.25);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);padding:16px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .ball{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle,#fff 0 48%,transparent 50%),conic-gradient(#111 0 60deg,#fff 0 120deg,#111 0 180deg,#fff 0 240deg,#111 0 300deg,#fff 0 360deg);box-shadow:0 0 14px rgba(255,255,255,.35)}
  .brand h1{margin:0;letter-spacing:.5px;line-height:1;font-size:28px;font-weight:800;text-transform:uppercase;text-shadow:0 3px 0 rgba(0,0,0,.5)}
  .brand h1 span{color:#7cf062}
  .code-box{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:center}
  .room-code{font-size:36px;font-weight:800;letter-spacing:2px}
  .btn{background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700;padding:12px 16px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);cursor:pointer}
  .players{display:grid;grid-template-columns:repeat(8,1fr);gap:16px;padding:0 4px}
  .player{background:linear-gradient(180deg,rgba(14,39,70,.9),rgba(10,30,53,.85));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:108px}
  .avatar{width:56px;height:56px;border-radius:50%;background:radial-gradient(36px 24px at 50% 30%,#ffd6b4 0 60%,#e9b089 61% 100%),radial-gradient(80px 40px at 50% 105%,#222 0 60%,transparent 61%),linear-gradient(180deg,#e23a3a,#a61e1e)}
  .avatar.placeholder{background:radial-gradient(28px 28px at 50% 40%,#2f4b73 0 60%,#203a5e 61% 100%),radial-gradient(48px 48px at 50% 110%,#162b4a 0 58%,transparent 59%)}
  .player small{color:var(--muted);font-weight:600}
  .settings{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:16px;letter-spacing:.3px;color:#cce0ff;text-transform:uppercase;font-weight:800}
  .selector{display:flex;align-items:center;justify-content:space-between;gap:8px;background:linear-gradient(180deg,#0b2441,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px}
  .selector .value{font-size:28px;font-weight:800}
  .selector .arrow{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;cursor:pointer;font-size:20px;font-weight:900}
  .cta{display:flex;justify-content:center}
  .btn-cta{background:linear-gradient(180deg,var(--yellow),var(--yellow-2));border:1px solid rgba(255,210,80,.9);color:#10223b;font-weight:900;font-size:28px;padding:16px 34px;border-radius:16px}
  #reveal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,10,20,.9)}
  .rev-card{width:min(680px,92vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:24px;text-align:center}
  .rev-content{padding:18px;background:linear-gradient(180deg,#102c4f,#0c2441);border:1px solid rgba(128,180,255,.25);border-radius:16px;min-height:110px;display:grid;place-items:center;font-size:26px;font-weight:800}
  /* === Nombre del jugador en la barra === */
.user-area{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
.userbox{
  display:flex;align-items:center;gap:8px;
  background:linear-gradient(180deg,#0c2747,#0a213b);
  border:1px solid rgba(128,180,255,.28);
  border-radius:12px;padding:8px 10px;font-weight:700;color:#cfe4ff
}
.mini-btn{
  padding:6px 10px;border-radius:10px;cursor:pointer;
  background:linear-gradient(180deg,#1e68d6,#184fa5);
  border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700
}
.me-badge{color:#ffd166;font-weight:900;margin-left:4px}
.me-outline{outline:2px solid #f6c11b;outline-offset:2px;border-radius:16px}
/* === Nombre del jugador en la barra === */
.user-area{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
.userbox{
  display:flex;align-items:center;gap:8px;
  background:linear-gradient(180deg,#0c2747,#0a213b);
  border:1px solid rgba(128,180,255,.28);
  border-radius:12px;padding:8px 10px;font-weight:700;color:#cfe4ff
}
.mini-btn{
  padding:6px 10px;border-radius:10px;cursor:pointer;
  background:linear-gradient(180deg,#1e68d6,#184fa5);
  border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700
}
.me-badge{color:#ffd166;font-weight:900;margin-left:4px}
.me-outline{outline:2px solid #f6c11b;outline-offset:2px;border-radius:16px}

</style>
</head>
<body>
  <div class="container">
    <div class="room-card">
      <div class="brand"><div class="ball"></div><h1>Impostor <span>FÃºtbol</span></h1></div>
      <div class="code-box"><strong style="opacity:.7">CÃ“DIGO:</strong><div class="room-code" id="roomCode">â€”</div><button id="copyBtn" class="btn">Copiar</button></div>
      <div class="user-area">
  <div class="userbox">ðŸ‘¤ <span id="meName">â€”</span>
    <button id="editName" class="mini-btn">Editar</button>
  </div>
  <button id="shareBtn" class="btn">Compartir enlace</button>
</div>

    </div>

    <div class="players" id="players"></div>

    <div class="settings">
      <div class="card"><h3>Impostores</h3><div class="selector"><div class="arrow" data-dec="impostores">â€¹</div><div class="value" id="impostoresVal">1</div><div class="arrow" data-inc="impostores">â€º</div></div></div>
      <div class="card"><h3>Jugadores</h3><div class="selector"><div class="arrow" data-dec="jugadores">â€¹</div><div class="value" id="jugadoresVal">8</div><div class="arrow" data-inc="jugadores">â€º</div></div></div>
      <div class="card"><h3>Tema</h3><div class="selector"><div class="arrow" data-dec="tema">â€¹</div><div class="value" id="temaVal">Clubes</div><div class="arrow" data-inc="tema">â€º</div></div></div>
    </div>

    <div class="cta"><button id="startBtn" class="btn-cta">EMPEZAR PARTIDA</button></div>
  </div>

  <!-- Overlay: cada jugador ve su propio rol -->
  <div id="reveal">
    <div class="rev-card">
      <h2>Tu rol</h2>
      <div id="revContent" class="rev-content"></div>
      <div style="margin-top:12px">
        <button id="btnComenzarRonda" class="btn-cta">ðŸš€ Comenzar ronda</button>
      </div>
    </div>
  </div>

<script type="module">
  // ===== Firebase =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
    collection, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

function getStoredName(){
  const qp = new URLSearchParams(location.search);
  const qName = qp.get("name");
  if (qName && qName.trim()) localStorage.setItem("displayName", qName.trim());
  const s = localStorage.getItem("displayName") || "";
  return (s.trim().length>=2 && s.trim().length<=16) ? s.trim() : "Jugador";
}
async function editAndSaveName(playerRef){
  const prev = getStoredName();
  const nuevo = prompt("Tu nombre para mostrar (2â€“16 chars):", prev) ?? "";
  const v = nuevo.trim();
  if (v.length<2 || v.length>16) return;
  localStorage.setItem("displayName", v);
  document.getElementById("meName").textContent = v;
  try{ if(playerRef) await updateDoc(playerRef, { name: v }); }catch(e){ console.warn(e); }
}

  
  const firebaseConfig = {
    apiKey: "AIzaSyAegeue7A8qFFW4IScFFgtvT4P1g2GLkCM",
    authDomain: "who-is-who-6ea99.firebaseapp.com",
    projectId: "who-is-who-6ea99",
    storageBucket: "who-is-who-6ea99.firebasestorage.app",
    messagingSenderId: "718537140049",
    appId: "1:718537140049:web:7400ec7e5467b387f8d570",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== Helpers cÃ³digo Ãºnico =====
  function genCode(len = 6){
    const A = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s = ""; for (let i=0;i<len;i++) s += A[Math.floor(Math.random()*A.length)];
    return s;
  }
  async function createUniqueRoomCode(db, tries = 10){
    for(let i=0;i<tries;i++){
      const candidate = genCode(6);
      const ref = doc(db, "rooms", candidate);
      const snap = await getDoc(ref);
      if(!snap.exists()) return candidate;
    }
    return genCode(8);
  }

  // ===== Util UI =====
  const $ = s => document.querySelector(s);
  const playersWrap = $("#players");
  const roomCodeEl  = $("#roomCode");
  const impostoresEl = $("#impostoresVal");
  const jugadoresEl  = $("#jugadoresVal");
  const temaEl       = $("#temaVal");

  const state = {
    code: "",            // se define mÃ¡s abajo
    impostores: 1,
    jugadores: 8,
    temas: ["Clubes","Jugadores","Mundiales"],
    temaIndex: 0
  };

  const POOLS = {
    Clubes:["Real Madrid","Barcelona","Boca Juniors","River Plate","PSG","Manchester City","Inter","AC Milan","Liverpool","Chelsea"],
    Jugadores:["Lionel Messi","Cristiano Ronaldo","Diego Maradona","PelÃ©","Kylian MbappÃ©","Erling Haaland","Neymar","Zinedine Zidane","Ronaldinho","Ronaldo NazÃ¡rio"],
    Mundiales:["Mundial 2002","Mundial 2006","Mundial 2010","Mundial 2014","Mundial 2018","Mundial 2022"]
  };
  const r=n=>Math.floor(Math.random()*n);
  const sample=a=>a[r(a.length)];
  const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=r(i+1);[a[i],a[j]]=[a[j],a[i]]}return a};

  function renderPlayers(n){
    playersWrap.innerHTML="";
    for(let i=1;i<=n;i++){
      const card=document.createElement("div"); card.className="player";
      const av=document.createElement("div"); av.className="avatar placeholder";
      const label=document.createElement("small"); label.textContent=`Jugador ${i}`;
      card.append(av,label); playersWrap.append(card);
    }
  }
  function render(){
    roomCodeEl.textContent = state.code || "â€”";
    impostoresEl.textContent = state.impostores;
    jugadoresEl.textContent  = state.jugadores;
    temaEl.textContent       = state.temas[state.temaIndex];
    renderPlayers(state.jugadores);
  }
  render();

  // ===== AutenticaciÃ³n y determinaciÃ³n de host / invitado =====
  await signInAnonymously(auth).catch(e=>console.warn("Anon auth:", e));

  const urlCode = new URLSearchParams(location.search).get("code");
  const isHost = !urlCode;

  if (isHost) {
    state.code = await createUniqueRoomCode(db); // <- cÃ³digo realmente Ãºnico
  } else {
    state.code = urlCode.toUpperCase();
  }
  render();

  const roomRef = doc(db, "rooms", state.code);

  // ===== Flechas (solo host persiste en Firestore) =====
  document.querySelectorAll(".arrow").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const inc = btn.dataset.inc, dec = btn.dataset.dec;
      if(inc==="impostores") state.impostores = Math.min(3, state.impostores+1);
      if(dec==="impostores") state.impostores = Math.max(1, state.impostores-1);
      if(inc==="jugadores")  state.jugadores  = Math.min(10,state.jugadores+1);
      if(dec==="jugadores")  state.jugadores  = Math.max(4, state.jugadores-1);
      if(inc==="tema") state.temaIndex = (state.temaIndex+1)%state.temas.length;
      if(dec==="tema") state.temaIndex = (state.temaIndex-1+state.temas.length)%state.temas.length;
      if(state.impostores >= state.jugadores) state.impostores = Math.max(1, state.jugadores-1);
      render();

      if (isHost){
        try{
          await updateDoc(roomRef, {
            settings:{
              maxPlayers: state.jugadores,
              impostors:  state.impostores,
              tema:       state.temas[state.temaIndex]
            }
          });
        }catch(e){ /* puede fallar si la sala aÃºn no existe */ }
      }
    });
  });

  // ===== Crear/Unirse a sala =====
  if (isHost){
    await setDoc(roomRef, {
      hostUid: auth.currentUser.uid,
      status: "lobby",
      createdAt: Date.now(),
      settings: { maxPlayers: state.jugadores, impostors: state.impostores, tema: state.temas[state.temaIndex] }
    }, { merge:true });

    await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid), {
      uid: auth.currentUser.uid, name: "Jugador 1", slot: 1, online: true
    }, { merge:true });

  } else {
    const snap = await getDoc(roomRef);
    if(!snap.exists()){ alert("La sala no existe"); location.href="index.html"; }
    const s = snap.data().settings || {};
    state.jugadores = s.maxPlayers || state.jugadores;
    state.impostores = s.impostors || state.impostores;
    state.temaIndex = ["Clubes","Jugadores","Mundiales"].indexOf(s.tema ?? "Clubes");
    if (state.temaIndex < 0) state.temaIndex = 0;
    render();

    await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid), {
      uid: auth.currentUser.uid, name: "Jugador", slot: Date.now(), online: true
    }, { merge:true });

    document.querySelectorAll(".arrow").forEach(b=>b.style.pointerEvents="none");
  }

  // ===== SincronÃ­a en vivo =====
  onSnapshot(roomRef, s=>{
    if(!s.exists()) return;
    const st = s.data().settings || {};
    state.jugadores = st.maxPlayers ?? state.jugadores;
    state.impostores = st.impostors ?? state.impostores;
    $("#temaVal").textContent = st.tema ?? state.temas[state.temaIndex];
    renderPlayers(state.jugadores);
  });

  onSnapshot(collection(db,"rooms",state.code,"players"), snap=>{
    const list = snap.docs.map(d=>d.data()).sort((a,b)=>(a.slot||0)-(b.slot||0));
    playersWrap.innerHTML = "";
for(let i=0;i<state.jugadores;i++){
  const p = list[i];
  const card=document.createElement("div"); card.className="player";
  const av=document.createElement("div"); av.className=p?"avatar":"avatar placeholder";
  const label=document.createElement("small");

  if(p){
    if(p.uid === auth.currentUser.uid){
      card.classList.add("me-outline");
      label.innerHTML = `${p.name || `Jugador ${i+1}`} <span class="me-badge">(yo)</span>`;
    }else{
      label.textContent = p.name || `Jugador ${i+1}`;
    }
  }else{
    label.textContent = `Jugador ${i+1}`;
  }

  card.append(av,label); playersWrap.append(card);
}

  });

  // ===== Empezar partida (solo host) =====
  $("#startBtn").addEventListener("click", async ()=>{
    if(!isHost){ alert("Solo el host puede iniciar"); return; }

    try{
      const roomData = (await getDoc(roomRef)).data();
      const tema = roomData.settings.tema;
      const K = roomData.settings.impostors;

      const ps = await getDocs(collection(db,"rooms",state.code,"players"));
      const players = ps.docs.map(d=>d.data());
      if(players.length < 3){ alert("Se necesitan al menos 3 jugadores."); return; }
      if(K >= players.length){ alert("Impostores debe ser menor que jugadores."); return; }

      const palabra = sample(POOLS[tema] || ["BalÃ³n"]);
      const seleccion = shuffle(players.slice());
      const impostores = new Set(seleccion.slice(0, K).map(p=>p.uid));

      const batch = writeBatch(db);
      players.forEach(p=>{
        batch.set(doc(db,"rooms",state.code,"assignments",p.uid), {
          role: impostores.has(p.uid) ? "IMPOSTOR" : "CIVIL",
          word: impostores.has(p.uid) ? null : palabra,
          tema
        });
      });
      batch.update(roomRef, { status:"playing" });
      await batch.commit();
      console.log("Roles asignados.");
    }catch(e){
      console.error("Error al iniciar:", e);
      alert("No pude iniciar la partida. RevisÃ¡ la consola.");
    }
  });

  // ===== Cada jugador ve su propio rol =====
  onSnapshot(doc(db,"rooms",state.code,"assignments",auth.currentUser.uid), s=>{
    if(!s.exists()) return;
    const a = s.data();
    const overlay = document.getElementById("reveal");
    const box = document.getElementById("revContent");
    overlay.style.display = "grid";
    if(a.role === "IMPOSTOR"){
      box.innerHTML = `<div><div style="font-size:38px;font-weight:900;color:#ff6b6b;margin-bottom:8px">IMPOSTOR</div><div style="opacity:.85">Tu objetivo es camuflarte. No conocÃ©s la palabra.</div></div>`;
    }else{
      box.innerHTML = `<div><div style="opacity:.75;font-size:14px;margin-bottom:6px">Palabra secreta (${a.tema})</div><div style="font-size:34px;font-weight:900;color:#7cf062">${a.word}</div></div>`;
    }
  });

  // Copiar / Compartir
  $("#copyBtn").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(state.code); }catch{}
  });
  $("#shareBtn").addEventListener("click", async ()=>{
    const joinUrl = `${location.origin}/ingresar.html?code=${state.code}`;
    if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`CÃ³digo ${state.code}`, url:joinUrl}); } catch{} }
    else { try{ await navigator.clipboard.writeText(joinUrl); alert("Enlace copiado"); } catch{ alert(joinUrl); } }
  });
</script>

</body>
</html>
