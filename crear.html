<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impostor F√∫tbol ‚Äì Lobby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--panel:#0f2b4b;--panel-2:#0c213a;--yellow:#f6c11b;--yellow-2:#f39c12;--text:#eaf2ff;--muted:#a7c0e8}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Outfit",system-ui;color:var(--text);background:url("fondo-cancha.png") center/cover fixed no-repeat;overflow:hidden}
  .container{width:min(1200px,92vw);margin:0 auto;padding:20px 0 28px;display:flex;flex-direction:column;gap:18px}
  .room-card{background:linear-gradient(180deg,rgba(7,28,56,.9),rgba(8,33,63,.88));border:1.5px solid rgba(128,180,255,.25);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);padding:16px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .ball{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle,#fff 0 48%,transparent 50%),conic-gradient(#111 0 60deg,#fff 0 120deg,#111 0 180deg,#fff 0 240deg,#111 0 300deg,#fff 0 360deg);box-shadow:0 0 14px rgba(255,255,255,.35)}
  .brand h1{margin:0;letter-spacing:.5px;line-height:1;font-size:28px;font-weight:800;text-transform:uppercase;text-shadow:0 3px 0 rgba(0,0,0,.5)}
  .brand h1 span{color:#7cf062}
  .code-box{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:center}
  .room-code{font-size:36px;font-weight:800;letter-spacing:2px}
  .btn{background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700;padding:12px 16px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);cursor:pointer}
  .players{display:grid;grid-template-columns:repeat(8,1fr);gap:16px;padding:0 4px}
  .player{background:linear-gradient(180deg,rgba(14,39,70,.9),rgba(10,30,53,.85));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:108px}
  .avatar{width:56px;height:56px;border-radius:50%;background:radial-gradient(36px 24px at 50% 30%,#ffd6b4 0 60%,#e9b089 61% 100%),radial-gradient(80px 40px at 50% 105%,#222 0 60%,transparent 61%),linear-gradient(180deg,#e23a3a,#a61e1e);display:grid;place-items:center;overflow:hidden}
  .avatar.placeholder{background:radial-gradient(28px 28px at 50% 40%,#2f4b73 0 60%,#203a5e 61% 100%),radial-gradient(48px 48px at 50% 110%,#162b4a 0 58%,transparent 59%)}
  .avatar-img{width:100%;height:100%;object-fit:cover;display:block}
  .player small{color:var(--muted);font-weight:600}
  .settings{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:16px;letter-spacing:.3px;color:#cce0ff;text-transform:uppercase;font-weight:800}
  .selector{display:flex;align-items:center;justify-content:space-between;gap:8px;background:linear-gradient(180deg,#0b2441,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px}
  .selector .value{font-size:28px;font-weight:800}
  .selector .arrow{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;cursor:pointer;font-size:20px;font-weight:900}
  .cta{display:flex;justify-content:center}
  .btn-cta{background:linear-gradient(180deg,var(--yellow),var(--yellow-2));border:1px solid rgba(255,210,80,.9);color:#10223b;font-weight:900;font-size:28px;padding:16px 34px;border-radius:16px}

  /* Overlay rol */
  #reveal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,10,20,.9);z-index:1000}
  .rev-card{width:min(680px,92vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:24px;text-align:center}
  .rev-content{padding:18px;background:linear-gradient(180deg,#102c4f,#0c2441);border:1px solid rgba(128,180,255,.25);border-radius:16px;min-height:110px;display:grid;place-items:center;font-size:26px;font-weight:800}
  .user-area{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .userbox{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:8px 10px;font-weight:700;color:#cfe4ff}
  .mini-btn{padding:6px 10px;border-radius:10px;cursor:pointer;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700}
  .me-badge{color:#ffd166;font-weight:900;margin-left:4px}
  .me-outline{outline:2px solid #f6c11b;outline-offset:2px;border-radius:16px}
  .rev-avatar{width:80px;height:80px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.35);margin:0 auto 10px;background:#0b203a;display:grid;place-items:center}
  .rev-avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .rev-name{font-weight:800;margin-top:4px;opacity:.9}
  .tip{background:#08213a;border:1px solid rgba(128,180,255,.25);padding:8px 12px;border-radius:12px;margin:10px;opacity:.9}

  /* === Sorteo (‚Äúbolillero‚Äù) === */
  #drawOverlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,12,24,.9);z-index:1200}
  .draw-card{width:min(760px,96vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:20px}
  .draw-title{margin:0 0 10px;text-align:center}
  .bowl{position:relative;height:240px;border-radius:16px;background:radial-gradient(circle at 50% 0%, rgba(255,255,255,.09), transparent 60%), linear-gradient(180deg,#0a2340,#0a1f37);border:1px solid rgba(128,180,255,.25);overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:16px}
  .ball{position:absolute;bottom:-40px;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff, #cfe1ff 55%, #82a8ff);opacity:.7;animation:float 3s ease-in-out infinite}
  .ball:nth-child(2){left:20%;animation-delay:.2s}.ball:nth-child(3){left:40%;animation-delay:.4s}.ball:nth-child(4){left:60%;animation-delay:.6s}.ball:nth-child(5){left:80%;animation-delay:.8s}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-18px)}100%{transform:translateY(0)}}
  .slip{position:absolute;bottom:12px;left:50%;transform:translateX(-50%) translateY(120%);background:#fff;color:#0c2441;border-radius:8px;padding:8px 12px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,.45);opacity:0;white-space:nowrap}
  .slip.reveal{animation:popUp .6s ease-out forwards}
  @keyframes popUp{0%{transform:translateX(-50%) translateY(120%) rotate(-6deg);opacity:0}
                   60%{transform:translateX(-50%) translateY(-26%) rotate(1deg);opacity:1}
                   100%{transform:translateX(-50%) translateY(-10%) rotate(0deg);opacity:1}}
  .order-list{margin:12px 4px 0;display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .order-item{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px}
  .order-badge{width:26px;height:26px;border-radius:8px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;font-weight:900}
  .order-name{font-weight:800}
</style>
</head>
<body>
  <div class="container">
    <div class="room-card">
      <div class="brand"><div class="ball"></div><h1>Impostor <span>F√∫tbol</span></h1></div>
      <div class="code-box"><strong style="opacity:.7">C√ìDIGO:</strong><div class="room-code" id="roomCode">‚Äî</div><button id="copyBtn" class="btn">Copiar</button></div>
      <div class="user-area">
        <div class="userbox">üë§ <span id="meName">‚Äî</span> <button id="editName" class="mini-btn">Editar</button></div>
        <button id="shareBtn" class="btn">Compartir enlace</button>
      </div>
    </div>

    <div class="players" id="players"></div>

    <div class="settings">
      <div class="card"><h3>Impostores</h3><div class="selector"><div class="arrow" data-dec="impostores">‚Äπ</div><div class="value" id="impostoresVal">1</div><div class="arrow" data-inc="impostores">‚Ä∫</div></div></div>
      <div class="card"><h3>Jugadores</h3><div class="selector"><div class="arrow" data-dec="jugadores">‚Äπ</div><div class="value" id="jugadoresVal">8</div><div class="arrow" data-inc="jugadores">‚Ä∫</div></div></div>
      <div class="card"><h3>Tema</h3><div class="selector"><div class="arrow" data-dec="tema">‚Äπ</div><div class="value" id="temaVal">Clubes</div><div class="arrow" data-inc="tema">‚Ä∫</div></div></div>
    </div>

    <div class="cta"><button id="startBtn" class="btn-cta">EMPEZAR PARTIDA</button></div>
  </div>

  <!-- Overlay: rol + countdown -->
  <div id="reveal">
    <div class="rev-card">
      <h2>Tu rol</h2>
      <div id="revContent" class="rev-content"></div>
      <div id="countdown" style="margin-top:12px;font-size:22px;font-weight:700;color:#f6c11b">Pasando en 10s...</div>
    </div>
  </div>

  <!-- Overlay: Sorteo del orden -->
  <div id="drawOverlay">
    <div class="draw-card">
      <h2 class="draw-title">Sorteo del orden</h2>
      <div class="bowl" id="bowl">
        <div class="ball"></div><div class="ball"></div><div class="ball"></div><div class="ball"></div><div class="ball"></div>
        <div class="slip" id="slip">‚Äî</div>
      </div>
      <div id="orderList" class="order-list"></div>
    </div>
  </div>

  <!-- FASE: DEBATE (chat) -->
  <div id="phaseDiscuss" style="display:none;position:fixed;inset:0;background:rgba(0,10,20,.9);padding:24px">
    <div style="max-width:900px;margin:0 auto;background:#0b203a;border:1px solid rgba(128,180,255,.3);border-radius:18px;height:86vh;display:flex;flex-direction:column">
      <div style="padding:14px 16px;border-bottom:1px solid rgba(128,180,255,.15);display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Debate</h2>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <small id="turnHint" style="opacity:.85"></small>
          <small id="cooldownHint" style="opacity:.7"></small>
        </div>
      </div>
      <div id="firstWordTip" class="tip" style="display:none">Primero, cada jugador debe enviar <strong>UNA</strong> palabra (2‚Äì24 letras). Despu√©s, chat libre.</div>
      <div id="chatList" style="flex:1;overflow:auto;padding:14px"></div>
      <form id="chatForm" style="padding:12px;display:flex;gap:10px;border-top:1px solid rgba(128,180,255,.15)">
        <input id="chatInput" maxlength="140" placeholder="Primero UNA palabra (2‚Äì24 letras)‚Ä¶"
               style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(128,180,255,.35);background:#0a213b;color:#eaf2ff">
        <button class="btn" type="submit">Enviar</button>
      </form>
      <div id="voteBar" style="padding:10px 12px;border-top:1px solid rgba(128,180,255,.15);display:flex;gap:10px;flex-wrap:wrap"></div>
    </div>
  </div>

  <script type="module">
  // ===== Firebase =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
    collection, getDocs, writeBatch, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAegeue7A8qFFW4IScFFgtvT4P1g2GLkCM",
    authDomain: "who-is-who-6ea99.firebaseapp.com",
    projectId: "who-is-who-6ea99",
    storageBucket: "who-is-who-6ea99.firebasestorage.app",
    messagingSenderId: "718537140049",
    appId: "1:718537140049:web:7400ec7e5467b387f8d570",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ‚úÖ Persistir el mismo usuario an√≥nimo entre recargas
  await setPersistence(auth, browserLocalPersistence);
  async function ensureAuth() {
    const user = await new Promise((resolve) => {
      const unsub = onAuthStateChanged(auth, (u) => { unsub(); resolve(u); });
    });
    if (!user) {
      const cred = await signInAnonymously(auth);
      return cred.user;
    }
    return user;
  }
  const user = await ensureAuth();

  const AVATAR_MAP = { a1:"avatars/a1.png",a2:"avatars/a2.png",a3:"avatars/a3.png",a4:"avatars/a4.png",a5:"avatars/a5.png",a6:"avatars/a6.png",a7:"avatars/a7.png",a8:"avatars/a8.png",a9:"avatars/a9.png",a10:"avatars/a10.png",a11:"avatars/a11.png",a12:"avatars/a12.png" };

  const $ = s => document.querySelector(s);
  const playersWrap = $("#players");
  const roomCodeEl  = $("#roomCode");
  const impostoresEl = $("#impostoresVal");
  const jugadoresEl  = $("#jugadoresVal");
  const temaEl       = $("#temaVal");
  const meNameEl     = document.getElementById("meName");

  function getStoredName(){
    const qp = new URLSearchParams(location.search);
    const qName = qp.get("name");
    if (qName && qName.trim()) localStorage.setItem("displayName", qName.trim());
    const s = localStorage.getItem("displayName") || "";
    return (s.trim().length>=2 && s.trim().length<=16) ? s.trim() : "Jugador";
  }
  function getStoredAvatar(){
    const qp = new URLSearchParams(location.search);
    const qAvatar = qp.get("avatar");
    if (qAvatar && AVATAR_MAP[qAvatar]) localStorage.setItem("avatarKey", qAvatar);
    const k = localStorage.getItem("avatarKey") || "";
    return AVATAR_MAP[k] ? k : "";
  }

  async function editAndSaveName(playerRef){
    const prev = getStoredName();
    const nuevo = prompt("Tu nombre para mostrar (2‚Äì16 chars):", prev) ?? "";
    const v = nuevo.trim();
    if (v.length<2 || v.length>16) return;
    localStorage.setItem("displayName", v);
    document.getElementById("meName").textContent = v;
    try{ if(playerRef) await updateDoc(playerRef, { name: v }); }catch(e){ console.warn(e); }
  }

  function genCode(len = 6){
    const A = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s = ""; for (let i=0;i<len;i++) s += A[Math.floor(Math.random()*A.length)];
    return s;
  }
  async function createUniqueRoomCode(db, tries = 10){
    for(let i=0;i<tries;i++){
      const candidate = genCode(6);
      const ref = doc(db, "rooms", candidate);
      const snap = await getDoc(ref);
      if(!snap.exists()) return candidate;
    }
    return genCode(8);
  }

  let lastPlayers = [];
  function drawPlayers(maxCount, list){
    const ordered = (list || []).slice().sort((a,b)=>(a.slot||0)-(b.slot||0));
    playersWrap.innerHTML = "";
    for (let i = 0; i < maxCount; i++){
      const p = ordered[i];
      const card = document.createElement("div"); card.className = "player";
      const av = document.createElement("div");
      const label = document.createElement("small");

      if (p){
        if (p.avatarKey && AVATAR_MAP[p.avatarKey]){
          av.className = "avatar";
          const img = document.createElement("img");
          img.className = "avatar-img";
          img.src = AVATAR_MAP[p.avatarKey];
          img.alt = p.name || "avatar";
          av.appendChild(img);
        } else {
          av.className = "avatar placeholder";
        }

        if (p.uid === (auth.currentUser && auth.currentUser.uid)){
          card.classList.add("me-outline");
          label.innerHTML = `${p.name || `Jugador ${i+1}`} <span class="me-badge">(yo)</span>`;
        } else {
          label.textContent = p.name || `Jugador ${i+1}`;
        }
      } else {
        av.className = "avatar placeholder";
        label.textContent = `Jugador ${i+1}`;
      }

      card.append(av,label);
      playersWrap.append(card);
    }
  }

  const state = { code:"", impostores:1, jugadores:8, temas:["Clubes","Jugadores","Mundiales"], temaIndex:0 };

  const POOLS = {
    Clubes:["Real Madrid","Barcelona","Boca Juniors","River Plate","PSG","Manchester City","Inter","AC Milan","Liverpool","Chelsea"],
    Jugadores:["Lionel Messi","Cristiano Ronaldo","Diego Maradona","Pel√©","Kylian Mbapp√©","Erling Haaland","Neymar","Zinedine Zidane","Ronaldinho","Ronaldo Naz√°rio"],
    Mundiales:["Mundial 2002","Mundial 2006","Mundial 2010","Mundial 2014","Mundial 2018","Mundial 2022"]
  };

  function render(){
    roomCodeEl.textContent = state.code || "‚Äî";
    impostoresEl.textContent = state.impostores;
    jugadoresEl.textContent  = state.jugadores;
    temaEl.textContent       = state.temas[state.temaIndex];
    drawPlayers(state.jugadores, lastPlayers);
  }

  // ===== Reusar la MISMA sala al recargar (URL + localStorage)
  const lsKey = "lastRoomCode";
  let isHost = false;

  function putCodeInUrl(code){
    try { history.replaceState(null, "", `?code=${code}`); } catch {}
  }

  let urlCode = new URLSearchParams(location.search).get("code");

  // 1) Si viene por URL, usarlo
  if (urlCode && urlCode.trim()) {
    state.code = urlCode.trim().toUpperCase();
    isHost = false;
  } else {
    // 2) Sin URL: intentar reusar el √∫ltimo de localStorage
    const prev = localStorage.getItem(lsKey);
    if (prev) {
      const prevRef = doc(db, "rooms", prev);
      const prevSnap = await getDoc(prevRef);
      if (prevSnap.exists()) {
        state.code = prev;
        isHost = (prevSnap.data().hostUid === (auth.currentUser && auth.currentUser.uid));
        putCodeInUrl(state.code);
      }
    }
    // 3) Si tampoco hay previo v√°lido ‚Üí crear una nueva sala (host)
    if (!state.code) {
      state.code = await createUniqueRoomCode(db);
      isHost = true;
      localStorage.setItem(lsKey, state.code);
      putCodeInUrl(state.code);
    }
  }

  render();

  const roomRef = doc(db, "rooms", state.code);

  const firstSnap = await getDoc(roomRef);
  if (!firstSnap.exists() && isHost) {
    await setDoc(roomRef, {
      hostUid: auth.currentUser.uid,
      status: "lobby",
      createdAt: Date.now(),
      settings: { maxPlayers: state.jugadores, impostors: state.impostores, tema: state.temas[state.temaIndex] }
    }, { merge:true });
  }
  if (firstSnap.exists()) {
    isHost = firstSnap.data().hostUid === auth.currentUser.uid;
  }
  if (isHost) {
    localStorage.setItem(lsKey, state.code);
    putCodeInUrl(state.code);
  }

  const myName   = getStoredName();
  const myAvatar = getStoredAvatar();
  meNameEl.textContent = myName;

  await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid), {
    uid: auth.currentUser.uid,
    name: myName,
    avatarKey: myAvatar || null,
    slot: isHost ? 1 : Date.now(),
    online: true
  }, { merge:true });

  const playerRef = doc(db,"rooms",state.code,"players",auth.currentUser.uid);
  document.getElementById("editName")?.addEventListener("click", ()=> editAndSaveName(playerRef));

  function setArrowsEnabled(enabled){
    document.querySelectorAll(".arrow").forEach(b=>{
      b.style.pointerEvents = enabled ? "auto" : "none";
      b.style.opacity = enabled ? "1" : ".55";
    });
  }
  setArrowsEnabled(isHost);

  document.querySelectorAll(".arrow").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const inc = btn.dataset.inc, dec = btn.dataset.dec;
      if(inc==="impostores") state.impostores = Math.min(3, state.impostores+1);
      if(dec==="impostores") state.impostores = Math.max(1, state.impostores-1);
      if(inc==="jugadores")  state.jugadores  = Math.min(10,state.jugadores+1);
      if(dec==="jugadores")  state.jugadores  = Math.max(4, state.jugadores-1);
      if(inc==="tema")       state.temaIndex  = (state.temaIndex+1)%state.temas.length;
      if(dec==="tema")       state.temaIndex  = (state.temaIndex-1+state.temas.length)%state.temas.length;
      if(state.impostores >= state.jugadores) state.impostores = Math.max(1, state.jugadores-1);
      state.jugadores = Math.max(state.jugadores, lastPlayers.length);
      render();
      if (isHost){
        await setDoc(roomRef, { settings:{ maxPlayers: state.jugadores, impostors: state.impostores, tema: state.temas[state.temaIndex] } }, { merge:true });
      }
    });
  });

  onSnapshot(roomRef, s=>{
    if(!s.exists()) return;
    const data = s.data();
    const before = isHost;
    isHost = (data.hostUid === auth.currentUser.uid);
    if (before !== isHost) setArrowsEnabled(isHost);

    const st = data.settings || {};
    state.jugadores  = st.maxPlayers ?? state.jugadores;
    state.impostores = st.impostors  ?? state.impostores;
    if (st.tema) {
      const idx = state.temas.indexOf(st.tema);
      state.temaIndex = idx >= 0 ? idx : 0;
    }
    render();
  });

  onSnapshot(collection(db,"rooms",state.code,"players"), snap=>{
    lastPlayers = snap.docs.map(d=>d.data());
    drawPlayers(state.jugadores, lastPlayers);
  });

  function pickWord(tema){
    const pool = POOLS[tema] || ["Bal√≥n"];
    return pool[Math.floor(Math.random() * pool.length)];
  }
  function shuffleInPlace(a){
    for (let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // ======== START: roles + ronda con ORDEN y status "reveal" -> (despu√©s) "draw"
  let starting = false;
  document.getElementById("startBtn").addEventListener("click", async ()=>{
    if (!isHost){ alert("Solo el host puede iniciar"); return; }
    if (starting) return; starting = true;

    try{
      const roomSnap = await getDoc(roomRef);
      if (!roomSnap.exists()){ alert("Sala no encontrada."); starting = false; return; }

      const room = roomSnap.data();
      const st   = room.settings || {};
      const tema = st.tema || "Clubes";
      const K    = st.impostors || 1;

      if (room.status === "playing"){
        alert("La partida ya est√° en curso.");
        starting = false; return;
      }

      const ps = await getDocs(collection(db, "rooms", state.code, "players"));
      const players = ps.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.id && p.online !== false);

      if (players.length < 3){ alert("Se necesitan al menos 3 jugadores."); starting = false; return; }
      if (K >= players.length){ alert("Impostores debe ser menor que jugadores."); starting = false; return; }

      const palabra = pickWord(tema);
      const order   = shuffleInPlace(players.map(p=>p.id)); // orden aleatorio UNA sola vez
      const impostorIds = new Set(order.slice(0, K));       // primeros K = impostores

      const nextRound = (room.round || 0) + 1;
      const batch = writeBatch(db);

      batch.update(roomRef, { status: "playing", round: nextRound, startedAt: serverTimestamp() });

      players.forEach(p=>{
        const aRef = doc(db, "rooms", state.code, "assignments", p.id);
        batch.set(aRef, {
          round: nextRound, uid: p.id, name: p.name || "Jugador", avatarKey: p.avatarKey || null,
          role: impostorIds.has(p.id) ? "IMPOSTOR" : "CIVIL",
          word: impostorIds.has(p.id) ? null : palabra, tema,
          alive: true, vote: null, revealedAt: null
        });
      });

      const roundRef = doc(db,"rooms",state.code,"rounds", String(nextRound));
      batch.set(roundRef, { status:"reveal", createdAt: serverTimestamp(), order, turnIndex: 0 });

      await batch.commit();

      // 10s para ver el rol -> luego lanzamos sorteo "draw"
      setTimeout(async ()=>{
        try{ await updateDoc(roundRef, { status:"draw", drawStartedAt: serverTimestamp() }); }catch(e){ console.warn(e); }
      }, 10000);

    }catch(e){
      console.error(e);
      alert(e.message || "No pude iniciar la partida.");
    }finally{
      starting = false;
    }
  });

  // ===== Overlay de rol + countdown de 10s (visual)
  onSnapshot(doc(db,"rooms",state.code,"assignments",auth.currentUser.uid), s=>{
    if(!s.exists()) return;
    const a = s.data();
    const overlay = document.getElementById("reveal");
    const box = document.getElementById("revContent");

    let avatarHtml = "";
    if (a.avatarKey && AVATAR_MAP[a.avatarKey]){
      avatarHtml = `<div class="rev-avatar"><img src="${AVATAR_MAP[a.avatarKey]}" alt="${a.name || 'avatar'}"></div>`;
    }
    const nameHtml = `<div class="rev-name">${a.name || "Jugador"}</div>`;

    overlay.style.display = "grid";
    if(a.role === "IMPOSTOR"){
      box.innerHTML = `${avatarHtml}${nameHtml}
        <div style="font-size:38px;font-weight:900;color:#ff6b6b;margin:6px 0 8px">IMPOSTOR</div>
        <div style="opacity:.85">Tu objetivo es camuflarte. No conoc√©s la palabra.</div>`;
    }else{
      box.innerHTML = `${avatarHtml}${nameHtml}
        <div style="opacity:.75;font-size:14px;margin:6px 0">Palabra secreta (${a.tema})</div>
        <div style="font-size:34px;font-weight:900;color:#7cf062">${a.word}</div>`;
    }

    let secs = 10;
    const countdownEl = document.getElementById("countdown");
    countdownEl.textContent = `Pasando en ${secs}s...`;
    const interval = setInterval(()=>{
      secs--;
      countdownEl.textContent = `Pasando en ${secs}s...`;
      if(secs <= 0){
        clearInterval(interval);
        overlay.style.display = "none";
      }
    },1000);
  });

  // ====== Sorteo del orden (animaci√≥n sincronizada)
  function sanitize(str){ return (str||"").replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])); }
  async function nameOf(uid){
    try{ const snap = await getDoc(doc(db,"rooms",state.code,"players", uid)); return (snap.exists() && (snap.data().name||"Jugador")) || "Jugador"; }
    catch{ return "Jugador"; }
  }

  async function startDrawAnimation(order){
    const draw = document.getElementById("drawOverlay");
    const slip = document.getElementById("slip");
    const list = document.getElementById("orderList");
    list.innerHTML = "";
    draw.style.display = "grid";

    // Precreamos placeholders en la lista
    const names = await Promise.all(order.map(uid=>nameOf(uid)));
    names.forEach((n,i)=>{
      const item = document.createElement("div");
      item.className = "order-item";
      item.innerHTML = `<div class="order-badge">${i+1}</div><div class="order-name" id="ord-${i}">‚Äî</div>`;
      list.appendChild(item);
    });

    // Revelamos uno por uno
    for (let i=0;i<order.length;i++){
      const n = names[i];
      slip.textContent = n;
      slip.classList.remove("reveal");
      void slip.offsetWidth; // reiniciar animaci√≥n
      slip.classList.add("reveal");
      await new Promise(r=>setTimeout(r, 900));
      const slot = document.getElementById(`ord-${i}`);
      if (slot) slot.textContent = n;
      await new Promise(r=>setTimeout(r, 450));
    }

    // Al terminar: host pasa a PROMPT
    const roomSnap = await getDoc(roomRef);
    const roundId = String(roomSnap.data().round || 0);
    if (isHost && roundId !== "0"){
      await updateDoc(doc(db,"rooms",state.code,"rounds", roundId), { status:"prompt", promptStartedAt: serverTimestamp(), turnIndex: 0 });
    }
    setTimeout(()=>{ draw.style.display = "none"; }, 600);
  }

  // ===== Orquestaci√≥n por estado de sala + ronda
  let currentRound = 0;
  let roundState = null;
  let drawPlayedForRound = 0; // evita repetir el bolillero por ronda

  // Suscriptores que limpiaremos al cambiar de ronda
  let unsubscribeRoundHint = null;
  let unsubscribeChat = null;

  function subscribeRoundHint(roundId){
    if (unsubscribeRoundHint) unsubscribeRoundHint();
    unsubscribeRoundHint = onSnapshot(
      doc(db, "rooms", state.code, "rounds", String(roundId)),
      (rdoc) => {
        if (!rdoc.exists()) return;
        const r = rdoc.data();
        roundState = r;
        if (r.status === "prompt") {
          const idx = r.turnIndex ?? 0;
          const uidTurno = (r.order || [])[idx];
          if (uidTurno) nameOf(uidTurno).then(n => {
            ui.turnHint.textContent = `Turno de: ${n}`;
          });
        }
      }
    );
  }

  function subscribeChat(roundId){
    if (unsubscribeChat) unsubscribeChat();
    unsubscribeChat = onSnapshot(
      collection(db,"rooms",state.code,"rounds", String(roundId), "chat"),
      snap=>{
        const items = snap.docs.map(d=>({id:d.id, ...d.data()}))
          .sort((a,b)=>(a.at?.seconds||0)-(b.at?.seconds||0));
        ui.chatList.innerHTML = items.map(m=>`
          <div style="margin:6px 0;padding:8px 10px;border-radius:12px;background:#0a2747;border:1px solid rgba(128,180,255,.18)">
            <strong style="opacity:.9">${sanitize(m.name) || "Jugador"}</strong>
            <div>${sanitize(m.text||"")}</div>
          </div>`).join("");
        ui.chatList.scrollTop = ui.chatList.scrollHeight;
      }
    );
  }

  onSnapshot(roomRef, async s=>{
    if(!s.exists()) return;
    const data = s.data();
    const newRound = data.round || 0;

    // Si cambi√≥ la ronda, (re)conectar hint + chat
    if (newRound && newRound !== currentRound){
      currentRound = newRound;
      subscribeRoundHint(currentRound);
      subscribeChat(currentRound);
    } else {
      currentRound = newRound;
    }
    if (!currentRound) return;

    const roundRef = doc(db,"rooms",state.code,"rounds", String(currentRound));
    const rdoc = await getDoc(roundRef);
    if (!rdoc.exists()) return;
    roundState = rdoc.data();

    const phase = roundState.status;
    if (phase === "reveal") {
      document.getElementById("phaseDiscuss").style.display = "none";
    }
    if (phase === "draw") {
      document.getElementById("phaseDiscuss").style.display = "none";
      if (drawPlayedForRound !== currentRound) {
        drawPlayedForRound = currentRound;
        startDrawAnimation(roundState.order || []);
      }
    }
    if (phase === "prompt") {
      document.getElementById("phaseDiscuss").style.display = "block";
      document.getElementById("firstWordTip").style.display = "block";
      ui.chatInput.placeholder = "Primero UNA palabra (2‚Äì24 letras)‚Ä¶";
      const idx = roundState.turnIndex ?? 0;
      const uidTurno = (roundState.order||[])[idx];
      ui.turnHint.textContent = uidTurno ? `Turno de: ${await nameOf(uidTurno)}` : "";
    }
    if (phase === "discuss") {
      document.getElementById("phaseDiscuss").style.display = "block";
      document.getElementById("firstWordTip").style.display = "none";
      ui.turnHint.textContent = "Chat libre";
      ui.chatInput.placeholder = "Dec√≠ tu pista/sospecha (3s cooldown)";
    }
    if (phase === "vote") {
      document.getElementById("phaseDiscuss").style.display = "block";
      ui.turnHint.textContent = "Votaci√≥n";
    }
  });

  // ===== Fallbacks de fase (solo host) =====
  onSnapshot(roomRef, async (snap) => {
    if (!snap.exists()) return;
    if (!isHost) return;

    const data = snap.data();
    const rId = data.round || 0;
    if (!rId) return;

    const rRef = doc(db, "rooms", state.code, "rounds", String(rId));
    const rDoc = await getDoc(rRef);
    if (!rDoc.exists()) return;

    const r = rDoc.data();
    const toMs = (ts) => ts?.toMillis?.() ?? (ts?.seconds ? ts.seconds * 1000 : (typeof ts === "number" ? ts : 0));

    const now       = Date.now();
    const createdMs = toMs(r.createdAt);
    const drawMs    = toMs(r.drawStartedAt);

    if (r.status === "reveal" && createdMs && now - createdMs > 11000) {
      try { await updateDoc(rRef, { status: "draw", drawStartedAt: serverTimestamp() }); } catch {}
    }
    if (r.status === "draw" && drawMs && now - drawMs > 20000) {
      try { await updateDoc(rRef, { status: "prompt", promptStartedAt: serverTimestamp(), turnIndex: 0 }); } catch {}
    }
  });

  // ===== UI / helpers chat
  const ui = {
    chatForm: document.getElementById("chatForm"),
    chatInput: document.getElementById("chatInput"),
    chatList: document.getElementById("chatList"),
    voteBar: document.getElementById("voteBar"),
    cooldownHint: document.getElementById("cooldownHint"),
    turnHint: document.getElementById("turnHint"),
  };

  let cooldownUntil = 0;
  function canSendNow(){
    const now = Date.now();
    if (roundState?.status === "prompt") return true;
    if (now < cooldownUntil) {
      const left = Math.ceil((cooldownUntil - now)/1000);
      ui.cooldownHint.textContent = `Esper√° ${left}s para volver a enviar`;
      return false;
    }
    ui.cooldownHint.textContent = "";
    return true;
  }

 function isOneWordLatin(str){
  return /^\p{L}{2,24}$/u.test(str);
}


 // Helper para mostrar errores visibles
function showError(msg){
  ui.cooldownHint.textContent = msg;
  ui.cooldownHint.style.color = "#ff7b7b";
  document.getElementById("chatInput").style.outline = "2px solid #ff7b7b";
  setTimeout(()=>{
    ui.cooldownHint.style.color = "";
    document.getElementById("chatInput").style.outline = "";
  }, 1800);
}

document.getElementById("chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!roundState) { showError("No hay ronda activa."); return; }

  const raw = (ui.chatInput.value || "").trim();
  if (!raw) return;

  const myUid = auth.currentUser?.uid;
  const roundId = String(currentRound);

  try {
    if (roundState.status === "prompt") {
      const idx = roundState.turnIndex ?? 0;
      const order = roundState.order || [];
      const uidTurno = order[idx];

      // üîí Chequeo de turno MUY expl√≠cito
      if (!myUid || !uidTurno || String(myUid) !== String(uidTurno)) {
        const name = uidTurno ? await nameOf(uidTurno) : "alguien";
        showError(`Esper√° tu turno. Ahora: ${name}.`);
        return;
      }

      // ‚úÖ Validaci√≥n de UNA palabra
      if (!isOneWordLatin(raw)) {
        showError("Envi√° UNA sola palabra (2‚Äì24 letras, sin espacios).");
        return;
      }

      // ‚úçÔ∏è Guardar "primera palabra" + mensaje de chat
      await setDoc(doc(db,"rooms",state.code,"rounds", roundId,"firstWords", myUid), {
        uid: myUid, name: getStoredName(), text: raw, at: serverTimestamp()
      });

      const msgRef = doc(collection(db,"rooms",state.code,"rounds", roundId, "chat"));
      await setDoc(msgRef, {
        uid: myUid, name: getStoredName(), text: raw, at: serverTimestamp(), kind:"firstword"
      });

      ui.chatInput.value = "";

      // üëë Avanzar turno solo si sos host
      if (isHost) {
        const nextIdx = idx + 1;
        if (nextIdx < order.length) {
          await updateDoc(doc(db,"rooms",state.code,"rounds", roundId), { turnIndex: nextIdx });
        } else {
          await updateDoc(doc(db,"rooms",state.code,"rounds", roundId), { status:"discuss", discussStartedAt: serverTimestamp() });
        }
      }
      return;
    }

    if (roundState.status === "discuss") {
      if (!canSendNow()) return;
      const msgRef = doc(collection(db,"rooms",state.code,"rounds", roundId, "chat"));
      await setDoc(msgRef, { uid: myUid, name: getStoredName(), text: raw, at: serverTimestamp(), kind:"chat" });
      ui.chatInput.value = "";
      cooldownUntil = Date.now() + 3000;
      canSendNow();
      return;
    }

    showError("No pod√©s enviar ahora.");

  } catch (e) {
    console.error(e);
    showError(`Error al enviar: ${e?.message || e}`);
  }
});


  // ===== Votaci√≥n
  async function renderVoteBar(){
    const asgSnap = await getDocs(collection(db,"rooms",state.code,"assignments"));
    const players = asgSnap.docs.map(d=>d.data()).filter(p=>p.alive!==false);
    document.getElementById("voteBar").innerHTML = players.map(p=>{
      const src = (p.avatarKey && AVATAR_MAP[p.avatarKey]) ? AVATAR_MAP[p.avatarKey] : "";
      return `
        <button class="btn" data-vote="${p.uid}" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px">
          <span style="width:28px;height:28px;border-radius:50%;overflow:hidden;display:inline-grid;place-items:center;background:#0a213b;border:1px solid rgba(128,180,255,.25)">
            ${src ? `<img src="${src}" style="width:100%;height:100%;object-fit:cover">` : "?"}
          </span>
          ${sanitize(p.name) || "Jugador"}
        </button>`;
    }).join("");
    document.querySelectorAll("[data-vote]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const votedUid = btn.getAttribute("data-vote");
        const roomSnap = await getDoc(roomRef);
        const roundId = roomSnap.data().round || 0;
        const myVoteRef = doc(db,"rooms",state.code,"rounds", String(roundId), "votes", auth.currentUser.uid);
        try{
          await setDoc(myVoteRef, { voter: auth.currentUser.uid, target: votedUid, at: serverTimestamp() });
          document.querySelectorAll("[data-vote]").forEach(b=>b.style.opacity=".6");
          btn.style.opacity = "1";
        }catch(e){ console.warn(e); }
      });
    });
  }

  onSnapshot(roomRef, async s=>{
    if(!s.exists()) return;
    const data = s.data();
    const roundRef = doc(db,"rooms",state.code,"rounds", String(data.round || 0));
    const rdoc = await getDoc(roundRef);
    if(!rdoc.exists()) return;
    const r = rdoc.data();
    if (r.status === "vote") {
      document.getElementById("phaseDiscuss").style.display = "block";
      renderVoteBar();
    }
  });

  onSnapshot(roomRef, async s=>{
    if(!s.exists()) return;
    const data = s.data();
    const roundId = data.round || 0;
    onSnapshot(collection(db,"rooms",state.code,"rounds", String(roundId), "votes"), async snap=>{
      const voted = new Set(snap.docs.map(d=>d.id));
      const asgSnap = await getDocs(collection(db,"rooms",state.code,"assignments"));
      const players = asgSnap.docs.map(d=>d.id).filter(Boolean);
      if (isHost && players.length>0 && players.every(id=>voted.has(id))) {
        await updateDoc(doc(db,"rooms",state.code,"rounds", String(roundId)), { status:"results", resultsAt: serverTimestamp() });
      }
    });
  });

  // Copiar / Compartir
  document.getElementById("copyBtn").addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(state.code); }catch{} });
  document.getElementById("shareBtn").addEventListener("click", async ()=>{
    const joinUrl = `${location.origin}/ingresar.html?code=${state.code}`;
    if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`C√≥digo ${state.code}`, url:joinUrl}); } catch{} }
    else { try{ await navigator.clipboard.writeText(joinUrl); alert("Enlace copiado"); } catch{ alert(joinUrl); } }
  });
</script>
</body>
</html>
