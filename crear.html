<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Impostor Fútbol – Lobby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --panel:#0f2b4b;--panel-2:#0c213a;--yellow:#f6c11b;--yellow-2:#f39c12;--text:#eaf2ff;--muted:#a7c0e8;
    --space:16px; /* espacio base adaptable */
  }
  *{box-sizing:border-box}

  /* ====== BASE ====== */
  html,body{height:100%;margin:0}
  body{
    font-family:"Outfit",system-ui;
    color:var(--text);
    background:url("fondo-cancha.png") center/cover no-repeat fixed;
    /* Altura real en móviles y safe-areas */
    min-height:100dvh;
    padding:
      calc(env(safe-area-inset-top,0px) + 8px)
      calc(env(safe-area-inset-right,0px) + 8px)
      calc(env(safe-area-inset-bottom,0px) + 8px)
      calc(env(safe-area-inset-left,0px) + 8px);
    overflow:auto; /* Permite scroll en vertical */
  }

  .container{
    width:min(1200px,96vw);
    margin:0 auto;
    padding:20px 0 28px;
    display:flex;flex-direction:column;gap:18px;
    min-height:calc(100dvh - 16px - 16px);
  }

  /* ====== ROOM CARD ====== */
  .room-card{
    background:linear-gradient(180deg,rgba(7,28,56,.9),rgba(8,33,63,.88));
    border:1.5px solid rgba(128,180,255,.25);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    padding:16px 18px;
    display:grid;
    grid-template-columns:auto 1fr auto;
    align-items:center; gap:16px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand .ball{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle,#fff 0 48%,transparent 50%),conic-gradient(#111 0 60deg,#fff 0 120deg,#111 0 180deg,#fff 0 240deg,#111 0 300deg,#fff 0 360deg);box-shadow:0 0 14px rgba(255,255,255,.35)}
  .brand h1{margin:0;letter-spacing:.5px;line-height:1;font-size:clamp(20px,4.8vw,28px);font-weight:800;text-transform:uppercase;text-shadow:0 3px 0 rgba(0,0,0,.5)}
  .brand h1 span{color:#7cf062}

  .code-box{
    background:linear-gradient(180deg,#0c2747,#0a213b);
    border:1px solid rgba(128,180,255,.28); border-radius:12px;
    padding:10px 12px;
    display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;
  }
  .room-code{font-size:clamp(22px,7vw,36px);font-weight:800;letter-spacing:2px}
  .btn{
    background:linear-gradient(180deg,#1e68d6,#184fa5);
    border:1px solid rgba(110,178,255,.65);
    color:#eaf2ff;font-weight:700;
    padding:10px 14px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
    cursor:pointer;
    font-size:clamp(12px,3.6vw,14px);
    touch-action:manipulation;
  }

  .user-area{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .userbox{
    display:flex;align-items:center;gap:8px;
    background:linear-gradient(180deg,#0c2747,#0a213b);
    border:1px solid rgba(128,180,255,.28);border-radius:12px;
    padding:8px 10px;font-weight:700;color:#cfe4ff
  }
  .mini-btn{padding:6px 10px;border-radius:10px;cursor:pointer;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700}
  .me-badge{color:#ffd166;font-weight:900;margin-left:4px}
  .me-outline{outline:2px solid #f6c11b;outline-offset:2px;border-radius:16px}

  /* ====== PLAYERS GRID (auto-fit) ====== */
  .players{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));
    gap:12px;
    padding:0 4px;
  }
  .player{
    background:linear-gradient(180deg,rgba(14,39,70,.9),rgba(10,30,53,.85));
    border:1px solid rgba(128,180,255,.25);border-radius:16px;
    padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:108px
  }
  .avatar{width:56px;height:56px;border-radius:50%;background:radial-gradient(36px 24px at 50% 30%,#ffd6b4 0 60%,#e9b089 61% 100%),radial-gradient(80px 40px at 50% 105%,#222 0 60%,transparent 61%),linear-gradient(180deg,#e23a3a,#a61e1e);display:grid;place-items:center;overflow:hidden}
  .avatar.placeholder{background:radial-gradient(28px 28px at 50% 40%,#2f4b73 0 60%,#203a5e 61% 100%),radial-gradient(48px 48px at 50% 110%,#162b4a 0 58%,transparent 59%)}
  .avatar-img{width:100%;height:100%;object-fit:cover;display:block}
  .player small{color:var(--muted);font-weight:600;font-size:clamp(11px,3.2vw,12px)}

  /* ====== SETTINGS GRID (auto-fit) ====== */
  .settings{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:12px;
  }
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:clamp(14px,3.8vw,16px);letter-spacing:.3px;color:#cce0ff;text-transform:uppercase;font-weight:800}
  .selector{display:flex;align-items:center;justify-content:space-between;gap:8px;background:linear-gradient(180deg,#0b2441,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px}
  .selector .value{font-size:clamp(20px,6.5vw,28px);font-weight:800}
  .selector .arrow{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;cursor:pointer;font-size:20px;font-weight:900}

  /* ====== CTA ====== */
  .cta{display:flex;justify-content:center;flex-wrap:wrap;gap:12px}
  .btn-cta{
    background:linear-gradient(180deg,var(--yellow),var(--yellow-2));
    border:1px solid rgba(255,210,80,.9);
    color:#10223b;font-weight:900;
    font-size:clamp(18px,6.5vw,28px);
    padding:14px 24px;border-radius:16px
  }

  /* ====== Overlay rol ====== */
  #reveal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,10,20,.9);z-index:1000;padding:16px}
  .rev-card{width:min(680px,96vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:20px;text-align:center}
  .rev-content{padding:16px;background:linear-gradient(180deg,#102c4f,#0c2441);border:1px solid rgba(128,180,255,.25);border-radius:16px;min-height:100px;display:grid;place-items:center;font-size:clamp(18px,5.8vw,26px);font-weight:800}
  .rev-avatar{width:80px;height:80px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.35);margin:0 auto 10px;background:#0b203a;display:grid;place-items:center}
  .rev-name{font-weight:800;margin-top:4px;opacity:.9}
  .tip{background:#08213a;border:1px solid rgba(128,180,255,.25);padding:8px 12px;border-radius:12px;margin:10px;opacity:.9}

  /* ====== Sorteo ====== */
  #drawOverlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,12,24,.9);z-index:1200;padding:16px}
  .draw-card{width:min(760px,96vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:16px}
  .draw-title{margin:0 0 10px;text-align:center}
  .bowl{position:relative;height:220px;border-radius:16px;background:radial-gradient(circle at 50% 0%, rgba(255,255,255,.09), transparent 60%), linear-gradient(180deg,#0a2340,#0a1f37);border:1px solid rgba(128,180,255,.25);overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:16px}
  .ball{position:absolute;bottom:-40px;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#cfe1ff 55%,#82a8ff);opacity:.7;animation:float 3s ease-in-out infinite}
  .ball:nth-child(2){left:20%;animation-delay:.2s}.ball:nth-child(3){left:40%;animation-delay:.4s}.ball:nth-child(4){left:60%;animation-delay:.6s}.ball:nth-child(5){left:80%;animation-delay:.8s}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
  .slip{position:absolute;bottom:12px;left:50%;transform:translateX(-50%) translateY(120%);background:#fff;color:#0c2441;border-radius:8px;padding:8px 12px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,.45);opacity:0;white-space:nowrap}
  .slip.reveal{animation:popUp .6s ease-out forwards}
  @keyframes popUp{0%{transform:translateX(-50%) translateY(120%) rotate(-6deg);opacity:0}
                   60%{transform:translateX(-50%) translateY(-26%) rotate(1deg);opacity:1}
                   100%{transform:translateX(-50%) translateY(-10%) rotate(0);opacity:1}}
  .order-list{margin:12px 4px 0;display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .order-item{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px}
  .order-badge{width:26px;height:26px;border-radius:8px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;font-weight:900}
  .order-name{font-weight:800}

  /* ====== Cartel de turno ====== */
  #turnBanner{
    position:absolute; top:38%; left:50%; transform:translate(-50%,-50%) scale(.92);
    display:none; padding:12px 18px; border-radius:16px;
    background:linear-gradient(135deg,#1e68d6,#4ade80);
    color:#fff; font-weight:900; font-size:clamp(16px,5.5vw,26px); letter-spacing:.3px;
    text-shadow:0 2px 10px rgba(0,0,0,.35);
    box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.2);
    pointer-events:none; z-index:5; opacity:0;
    transition:transform .35s ease, opacity .35s ease;
  }
  #turnBanner.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1);}
  #turnBanner.hide{opacity:0;transform:translate(-50%,-50%) scale(.92);}
  #turnBanner .who{font-size:clamp(18px,6vw,30px);text-transform:uppercase;}

  /* ====== Chat (fase debate) ====== */
  #chatList{ padding:14px; }
  .chat-row{ display:flex; margin:8px 0; }
  .chat-row.mine{ justify-content:flex-end; }
  .chat-row.other{ justify-content:flex-start; }
  .bubble{
    max-width:80%;
    padding:10px 14px; border-radius:16px;
    background:#142946; border:1px solid rgba(128,180,255,.18);
    color:#cfe4ff; box-shadow:0 4px 12px rgba(0,0,0,.25);
    animation:fadeUp .25s ease;
    font-size:clamp(13px,4vw,16px);
  }
  .chat-row.mine .bubble{
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:#fff; border-color:rgba(255,255,255,.2);
  }
  .bubble .name{ font-weight:800; opacity:.9; margin-bottom:2px; font-size:clamp(11px,3.2vw,13px); }
  .bubble .text{ font-size:inherit }
  @keyframes fadeUp{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}

  /* ====== RESPONSIVE LAYOUT ====== */
  @media (max-width: 900px){
    body{ background-attachment:scroll; }
    .room-card{
      grid-template-columns:1fr;
      grid-auto-rows:auto;
      gap:12px;
      text-align:center;
    }
    .user-area{align-items:center}
  }
  @media (max-width: 420px){
    .selector .arrow{width:36px;height:36px}
    .avatar{width:52px;height:52px}
    .order-list{grid-template-columns:1fr}
  }

  /* ====== MEJORAS VISUALES (FIFA-like) ====== */
  :root{ --glow:#7cf062; --shine:rgba(255,255,255,.18); }
  .room-card,.card,.selector,.userbox,.code-box{
    backdrop-filter:saturate(1.2) blur(6px);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 10px 26px rgba(0,0,0,.35);
  }
  .card:hover,.player:hover{
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 14px 34px rgba(0,0,0,.45);
    transform:translateY(-1px);
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .btn,.btn-cta{transition:transform .15s ease, box-shadow .15s ease, filter .15s ease}
  .btn:hover,.btn-cta:hover{transform:translateY(-1px)}
  .btn:active,.btn-cta:active{transform:translateY(0)}
  .btn:focus-visible,.btn-cta:focus-visible{ outline:2px solid var(--glow); outline-offset:2px; }
  .btn-cta{ position:relative; overflow:hidden; box-shadow:0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.2); }
  .btn-cta::after{
    content:""; position:absolute; inset:0; translate:-120% 0;
    background:linear-gradient(110deg, transparent 0 40%, var(--shine) 50%, transparent 60% 100%);
    animation:shine 2.8s linear infinite;
  }
  @keyframes shine{ to{ translate:120% 0 } }
  .me-outline{ box-shadow:0 0 0 2px #f6c11b, 0 0 22px rgba(246,193,27,.25) !important; }
  #toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%) translateY(20px);
    background:linear-gradient(180deg,#0d2747,#0b203a);
    border:1px solid rgba(128,180,255,.35); color:#eaf2ff;
    padding:10px 14px; border-radius:12px; z-index:2000; opacity:0; pointer-events:none;
    box-shadow:0 12px 28px rgba(0,0,0,.45);
    transition:opacity .22s ease, transform .22s ease; font-weight:800
  }
  #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  body::before{
    content:""; position:fixed; inset:-10% -10% auto -10%; height:55%;
    background:radial-gradient(60% 55% at 80% 0%, rgba(110,178,255,.18), transparent 60%),
                radial-gradient(60% 55% at 20% 0%, rgba(110,178,255,.18), transparent 60%);
    pointer-events:none; animation:lights 6s ease-in-out infinite alternate; z-index:0;
  }
  @keyframes lights{ from{opacity:.55; filter:blur(0)} to{opacity:.85; filter:blur(1px)} }
  .container{ position:relative; z-index:1 }
  .icon { width:1.1em; height:1.1em; display:inline-block; vertical-align:-0.15em; }
.icon-btn { display:inline-flex; align-items:center; gap:8px; }
.player{
  position:relative;
  background:
    linear-gradient(180deg,rgba(14,39,70,.92),rgba(10,30,53,.88)),
    radial-gradient(120% 60% at 50% -10%, rgba(124,240,98,.15), transparent 60%);
  border-radius:18px;
  border:1px solid rgba(128,180,255,.28);
}
.player::before{
  content:"";
  position:absolute; inset:1px;
  background:linear-gradient(120deg,transparent 30%, rgba(255,255,255,.08) 50%, transparent 70%);
  border-radius:16px; pointer-events:none;
}
.badge-captain{
  position:absolute; top:8px; right:8px;
  width:22px; height:22px; border-radius:6px;
  display:grid; place-items:center;
  background:linear-gradient(180deg,#f6c11b,#f39c12);
  color:#10223b; box-shadow:0 4px 10px rgba(0,0,0,.35);
}
.kick-btn{
  margin-left:6px; border:none; background:transparent; cursor:pointer;
  color:#ff6b6b; display:inline-flex; align-items:center;
}
.btn-cta{
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), transparent 40%),
    repeating-conic-gradient(from 0deg, rgba(255,255,255,.08) 0 12deg, transparent 12deg 24deg),
    linear-gradient(180deg,var(--yellow),var(--yellow-2)) !important;
}
.btn-cta:hover{ filter:saturate(1.05) brightness(1.03); }
/* === LOADER OVERLAY (5s) === */
#loader-overlay{
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center; flex-direction:column; gap:18px;
  background: linear-gradient(180deg, rgba(3,12,30,.96), rgba(8,22,40,.96));
  transition: opacity 400ms ease, visibility 400ms ease;
  opacity:1; visibility:visible;
}
#loader-overlay.hidden{ opacity:0; visibility:hidden; pointer-events:none; }

.loader-card{
  display:flex; align-items:center; gap:14px;
  padding:18px 22px; border-radius:14px;
  background: rgba(255,255,255,0.04);
  box-shadow: 0 10px 30px rgba(2,6,20,0.6);
  backdrop-filter: blur(6px);
}
.spinner{
  width:56px; height:56px; border-radius:50%;
  border:6px solid rgba(255,255,255,0.12);
  border-top-color: var(--yellow);
  animation: spin 1s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

#app-wrapper{ opacity:1; transition: opacity 350ms ease; }
#app-wrapper.hidden{ opacity:0; pointer-events:none; user-select:none; }

</style>
</head>
<body>
<script>window.__loaderStart = performance.now();</script>

<div id="loader-overlay" aria-hidden="false" role="status">
  <div class="loader-card">
    <div class="spinner" aria-hidden="true"></div>
    <div>
      <div style="font-weight:800">Cargando el sitio…</div>
      <div style="opacity:.8;font-size:12px">Preparando todo (5s)</div>
    </div>
  </div>
</div>

<div id="app-wrapper" class="hidden">
<!-- Sprite de íconos -->
<svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true">
  <symbol id="i-user" viewBox="0 0 24 24">
    <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5a5 5 0 0 0 5 5m0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5"/>
  </symbol>
  <symbol id="i-crown" viewBox="0 0 24 24">
    <path fill="currentColor" d="M2 7l4 3l4-5l4 5l4-3l2 12H0z"/>
  </symbol>
  <symbol id="i-eye" viewBox="0 0 24 24">
    <path fill="currentColor" d="M12 5c7 0 10 7 10 7s-3 7-10 7S2 12 2 12s3-7 10-7m0 3a4 4 0 1 0 0 8a4 4 0 0 0 0-8"/>
  </symbol>
  <symbol id="i-eye-off" viewBox="0 0 24 24">
    <path fill="currentColor" d="M2 4.27L3.28 3L21 20.72L19.73 22l-3.03-3.03A10.9 10.9 0 0 1 12 19c-7 0-10-7-10-7a18.7 18.7 0 0 1 5.31-6.04L2 4.27M12 7a5 5 0 0 1 5 5c0 .88-.24 1.69-.66 2.39L9.61 7.66A4.9 4.9 0 0 1 12 7Z"/>
  </symbol>
  <symbol id="i-lock" viewBox="0 0 24 24">
    <path fill="currentColor" d="M12 1a5 5 0 0 1 5 5v3h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h1V6a5 5 0 0 1 5-5m3 8V6a3 3 0 1 0-6 0v3z"/>
  </symbol>
  <symbol id="i-globe" viewBox="0 0 24 24">
    <path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2m6.92 6h-3.26A14.4 14.4 0 0 0 15 4.46A8 8 0 0 1 18.92 8M12 4a12.5 12.5 0 0 1 1.84 4H10.2A12.5 12.5 0 0 1 12 4M5.08 8A8 8 0 0 1 9 4.46A14.4 14.4 0 0 0 8.34 8zm13.84 8h-3.26c.26-.9.45-1.9.58-3h3.5a8 8 0 0 1-.82 3M10.2 17H13.8a12.5 12.5 0 0 1-1.8 3a12.5 12.5 0 0 1-1.8-3M4.58 13h3.5c.12 1.1.32 2.1.58 3H5.42A8 8 0 0 1 4.58 13"/>
  </symbol>
  <symbol id="i-whistle" viewBox="0 0 24 24">
    <path fill="currentColor" d="M17 6h5v5h-2a7 7 0 1 1-7-7h4z"/>
  </symbol>
  <symbol id="i-ball" viewBox="0 0 24 24">
    <path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2m1 3l3 2l-1 3l-3 1l-3-1l-1-3l3-2zm-8 7l2-3l3 1l1 3l-2 2l-3-1zm14 0l-3 1l-2-2l1-3l3-1l1 3zM9 19l1-3l3-1l3 1l-1 3l-3 1z"/>
  </symbol>
  <symbol id="i-x" viewBox="0 0 24 24">
    <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/>
  </symbol>
  <symbol id="i-chevron" viewBox="0 0 24 24">
    <path fill="currentColor" d="M9 6l6 6l-6 6"/>
  </symbol>
</svg>

  <div class="container">
    <div class="room-card">
      <div class="brand"><div class="ball"></div><h1>Impostor <span>Fútbol</span></h1></div>
      <div class="code-box">
        <strong style="opacity:.7">CÓDIGO:</strong>
        <div class="room-code" id="roomCode">—</div>
        <button id="toggleCodeBtn" class="btn">👁️ Mostrar código</button>
        <button id="copyBtn" class="btn">Copiar</button>
      </div>
      <div class="user-area">
      <div class="userbox">
  <svg class="icon"><use href="#i-user"></use></svg>
  <span id="meName">—</span>
  <button id="editName" class="mini-btn">Editar</button>
</div>
        <button id="shareBtn" class="btn">Compartir enlace</button>
      </div>
    </div>

    <div class="players" id="players"></div>

    <div class="settings">
      <div class="card"><h3>Impostores</h3><div class="selector"><div class="arrow" data-dec="impostores">‹</div><div class="value" id="impostoresVal">1</div><div class="arrow" data-inc="impostores">›</div></div></div>
      <div class="card"><h3>Jugadores</h3><div class="selector"><div class="arrow" data-dec="jugadores">‹</div><div class="value" id="jugadoresVal">8</div><div class="arrow" data-inc="jugadores">›</div></div></div>
      <div class="card"><h3>Tema</h3><div class="selector"><div class="arrow" data-dec="tema">‹</div><div class="value" id="temaVal">Clubes</div><div class="arrow" data-inc="tema">›</div></div></div>
      <div class="card"><h3>Tiempo</h3><div class="selector"><div class="arrow" data-dec="tiempo">‹</div><div class="value" id="tiempoVal">60s</div><div class="arrow" data-inc="tiempo">›</div></div></div>

      <div class="card">
  <h3>Privacidad</h3>
  <div class="selector" style="justify-content:center">
    <button id="togglePrivacyBtn" class="btn icon-btn">
      <svg class="icon"><use href="#i-lock"></use></svg> Privada
    </button>
    <small id="privacyHint" style="opacity:.8;font-weight:700">Solo con código</small>
  </div>
</div>
    </div>

    <div class="cta">
      <button id="startBtn" class="btn-cta">EMPEZAR PARTIDA</button>
      <button id="leaveBtn" class="btn" style="display:none">ABANDONAR PARTIDA</button>
      <button id="deleteRoomBtn" class="btn" style="display:none;background:linear-gradient(180deg,#ea4335,#c92e21);border-color:#ffb3ac">ELIMINAR SALA</button>
    </div>
  </div>

  <!-- Overlay: rol + countdown -->
  <div id="reveal">
    <div class="rev-card">
      <h2 style="margin:0 0 10px;font-size:clamp(18px,6vw,24px)">Tu rol</h2>
      <div id="revContent" class="rev-content"></div>
      <div id="countdown" style="margin-top:12px;font-size:clamp(16px,5.3vw,22px);font-weight:700;color:#f6c11b">Pasando en 10s...</div>
    </div>
  </div>

  <!-- Overlay: Sorteo del orden -->
  <div id="drawOverlay">
    <div class="draw-card">
      <h2 class="draw-title" style="font-size:clamp(18px,6vw,24px)">Sorteo del orden</h2>
      <div class="bowl" id="bowl">
        <div class="ball"></div><div class="ball"></div><div class="ball"></div><div class="ball"></div><div class="ball"></div>
        <div class="slip" id="slip">—</div>
      </div>
      <div id="orderList" class="order-list"></div>
    </div>
  </div>

  <!-- Overlay: Resultados -->
  <div id="resultsOverlay" style="display:none;position:fixed;inset:0;z-index:1400;place-items:center;background:rgba(0,10,20,.9);padding:16px">
    <div class="rev-card" style="width:min(680px,96vw)">
      <h2 style="margin:0 0 10px;font-size:clamp(18px,6vw,24px)">Resultados</h2>
      <div id="resultsBox" class="rev-content"></div>
      <div class="tip" id="resultsSub" style="margin-top:10px;opacity:.9"></div>
    </div>
  </div>

  <!-- FASE: DEBATE (chat) -->
  <div id="phaseDiscuss" style="display:none;position:fixed;inset:0;background:rgba(0,10,20,.9);padding:clamp(12px,2.5vw,24px)">
    <div style="max-width:min(900px,96vw);margin:0 auto;background:#0b203a;border:1px solid rgba(128,180,255,.3);border-radius:18px;height:calc(100dvh - 2*clamp(12px,2.5vw,24px) - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px));display:flex;flex-direction:column;position:relative">
<div id="turnBanner">${icon("i-ball")} Va <span id="turnName" class="who">—</span></div>

      <div style="padding:14px 16px;border-bottom:1px solid rgba(128,180,255,.15);display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:clamp(18px,6vw,22px)">Debate</h2>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:clamp(11px,3.5vw,13px)">
          <small id="timer" style="opacity:.9;font-weight:800"></small>
          <small id="turnHint" style="opacity:.85"></small>
          <small id="cooldownHint" style="opacity:.7"></small>
        </div>
      </div>
      <div id="firstWordTip" class="tip" style="display:none">Primero, cada jugador debe enviar <strong>UNA</strong> palabra (2–24 letras). Después, chat libre.</div>
      <div id="chatList" style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch"></div>
      <form id="chatForm" style="padding:12px;display:flex;gap:10px;border-top:1px solid rgba(128,180,255,.15)">
        <input id="chatInput" maxlength="140" placeholder="Primero UNA palabra (2–24 letras)…"
               style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(128,180,255,.35);background:#0a213b;color:#eaf2ff;font-size:clamp(14px,4.2vw,16px)">
        <button class="btn" type="submit">Enviar</button>
      </form>
      <div id="voteBar" style="padding:10px 12px;border-top:1px solid rgba(128,180,255,.15);display:flex;gap:10px;flex-wrap:wrap"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, getDocs, writeBatch, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAegeue7A8qFFW4IScFFgtvT4P1g2GLkCM",
    authDomain: "who-is-who-6ea99.firebaseapp.com",
    projectId: "who-is-who-6ea99",
    storageBucket: "who-is-who-6ea99.firebasestorage.app",
    messagingSenderId: "718537140049",
    appId: "1:718537140049:web:7400ec7e5467b387f8d570",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  await setPersistence(auth, browserLocalPersistence);
  async function ensureAuth(){
    const u = await new Promise(r=>{ const un = onAuthStateChanged(auth,(x)=>{un(); r(x);}); });
    return u || (await signInAnonymously(auth)).user;
  }
  await ensureAuth();

const AVATAR_MAP = {
  maradona:   "avatars/maradona.png",
  ronaldo:    "avatars/ronaldo.png",
  cristiano:  "avatars/cristiano.png",
  ronaldinho: "avatars/ronaldinho.png",
  lamine:     "avatars/lamine.png",
  odegar:     "avatars/odegar.png",
};

  const $ = s => document.querySelector(s);
  const roomCodeEl  = $("#roomCode");
  const meNameEl    = $("#meName");
  const playersWrap = $("#players");
  const leaveBtn = document.getElementById("leaveBtn");
  const deleteRoomBtn = document.getElementById("deleteRoomBtn");
  const togglePrivacyBtn = document.getElementById("togglePrivacyBtn");
  const toggleCodeBtn = document.getElementById("toggleCodeBtn");
  const privacyHint = document.getElementById("privacyHint");

  function icon(id){
  return `<svg class="icon"><use href="#${id}"></use></svg>`;
}

  /* ======= TOAST simple ======= */
  function showToast(msg, ms=1400){
    const t = document.getElementById("toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(showToast._h);
    showToast._h = setTimeout(()=> t.classList.remove("show"), ms);
  }

  /* ======= PRIVACIDAD & VISIBILIDAD DE CÓDIGO ======= */
  let showCode = false;      // oculto por defecto
  let isPublic = false;      // privada por defecto

  function updatePrivacyUI(){
  togglePrivacyBtn.innerHTML = isPublic
    ? `${icon("i-globe")} Pública`
    : `${icon("i-lock")} Privada`;
  privacyHint.textContent = isPublic ? "Aparece en listado público" : "Solo con código";
  togglePrivacyBtn.style.background = isPublic
    ? "linear-gradient(180deg,#22c55e,#16a34a)"
    : "linear-gradient(180deg,#1e68d6,#184fa5)";
}

  function updateCodeVisibility(){
  roomCodeEl.textContent = showCode ? (state.code || "—") : "••••••";
  toggleCodeBtn.innerHTML = showCode
    ? `${icon("i-eye-off")} Ocultar código`
    : `${icon("i-eye")} Mostrar código`;
}


  togglePrivacyBtn.addEventListener("click", async ()=>{
    if(!isHost){ alert("Solo el host puede cambiar esto."); return; }
    isPublic = !isPublic;
    updatePrivacyUI();
    try{ await updateDoc(roomRef,{ isPublic }); }catch(e){ console.warn(e); }
    showToast(isPublic ? "🌍 Sala pública" : "🔒 Sala privada");
  });
  toggleCodeBtn.addEventListener("click", ()=>{
    showCode = !showCode; updateCodeVisibility();
    showToast(showCode ? "👁️ Código visible" : "🙈 Código oculto");
  });

  function getStoredName(){
    const qp = new URLSearchParams(location.search);
    const qName = qp.get("name");
    if (qName && qName.trim()) localStorage.setItem("displayName", qName.trim());
    const s = localStorage.getItem("displayName") || "";
    return (s.trim().length>=2 && s.trim().length<=16) ? s.trim() : "Jugador";
  }
  function getStoredAvatar(){
  const qp = new URLSearchParams(location.search);
  const qAvatar = qp.get("avatar");             // viene de index.html
  if (qAvatar && AVATAR_MAP[qAvatar]) {
    localStorage.setItem("avatarKey", qAvatar);
  }
  const k = localStorage.getItem("avatarKey") || "";
  return AVATAR_MAP[k] ? k : "";                // si no existe, vuelve vacío (placeholder)
}


  async function editAndSaveName(playerRef){
    const prev = getStoredName();
    const nuevo = prompt("Tu nombre para mostrar (2–16 chars):", prev) ?? "";
    const v = nuevo.trim();
    if (v.length<2 || v.length>16) return;
    localStorage.setItem("displayName", v);
    meNameEl.textContent = v;
    try{ if(playerRef) await updateDoc(playerRef, { name: v }); }catch{}
  }

  function genCode(len=6){const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="";for(let i=0;i<len;i++) s+=A[Math.floor(Math.random()*A.length)];return s;}
  async function createUniqueRoomCode(db,tries=10){
    for(let i=0;i<tries;i++){const c=genCode(6);const ref=doc(db,"rooms",c);if(!(await getDoc(ref)).exists()) return c;}
    return genCode(8);
  }

  let lastPlayers=[];
  let hostUid = null; // <<< NUEVO: guardamos uid del host

  function drawPlayers(maxCount,list){
    const ordered=(list||[]).slice().sort((a,b)=>(a.slot||0)-(b.slot||0));
    playersWrap.innerHTML="";
    for(let i=0;i<maxCount;i++){
      const p=ordered[i];
      const card=document.createElement("div"); card.className="player";
      const av=document.createElement("div"); const label=document.createElement("small");
      if(p){
        if(p.avatarKey && AVATAR_MAP[p.avatarKey]){
          av.className="avatar";
          const img=document.createElement("img"); img.className="avatar-img"; img.src=AVATAR_MAP[p.avatarKey]; img.alt=p.name||"avatar"; av.appendChild(img);
        }else{ av.className="avatar placeholder"; }
        const isMe = p.uid===(auth.currentUser&&auth.currentUser.uid);
const isCap = hostUid && p.uid===hostUid;

if(isCap){
  const cap = document.createElement("div");
  cap.className = "badge-captain";
  cap.innerHTML = `<svg class="icon" style="width:16px;height:16px"><use href="#i-crown"></use></svg>`;
  card.append(cap);
}

if(isMe){
  card.classList.add("me-outline");
  label.innerHTML = `${p.name||`Jugador ${i+1}`} <span class="me-badge">(yo)</span>`;
}else{
  label.textContent = p.name || `Jugador ${i+1}`;
  if(isHost){
    const kick=document.createElement("button");
    kick.className="kick-btn";
    kick.title="Expulsar";
    kick.innerHTML = `<svg class="icon"><use href="#i-x"></use></svg>`;
    kick.onclick=async()=>{
      if(confirm(`Expulsar a ${p.name||'Jugador'}?`)){
        try{ await deleteDoc(doc(db,"rooms",state.code,"players",p.uid)); }catch(e){ console.warn(e); }
      }
    };
    label.append(kick);
  }
}
      }else{ av.className="avatar placeholder"; label.textContent=`Jugador ${i+1}`; }
      card.append(av,label); playersWrap.append(card);
    }
  }

  const impostoresEl = document.getElementById("impostoresVal");
  const jugadoresEl  = document.getElementById("jugadoresVal");
  const temaEl       = document.getElementById("temaVal");
  const tiempoEl     = document.getElementById("tiempoVal");

  // Estado
  const state={ 
    code:"",
    impostores:1, 
    jugadores:8, 
    temas:["Clubes","Jugadores","Mundiales"], 
    temaIndex:0,
    tiempos:[30,45,60,90,120],
    tiempoIndex:2 // 60s
  };

  function render(){
    roomCodeEl.textContent = showCode ? (state.code || "—") : "••••••";
    impostoresEl.textContent = state.impostores;
    jugadoresEl.textContent  = state.jugadores;
    temaEl.textContent       = state.temas[state.temaIndex];
    tiempoEl.textContent     = state.tiempos[state.tiempoIndex] + "s";
    drawPlayers(state.jugadores, lastPlayers);
  }

  // Reusar sala
  const lsKey="lastRoomCode"; let isHost=false;
  function putCodeInUrl(code){ try{ history.replaceState(null,"",`?code=${code}`);}catch{} }
  let urlCode=new URLSearchParams(location.search).get("code");
  if(urlCode && urlCode.trim()){ state.code=urlCode.trim().toUpperCase(); isHost=false; }
  else{
    const prev=localStorage.getItem(lsKey);
    if(prev){
      const prevSnap=await getDoc(doc(db,"rooms",prev));
      if(prevSnap.exists()){ state.code=prev; isHost=(prevSnap.data().hostUid===(auth.currentUser&&auth.currentUser.uid)); putCodeInUrl(state.code); }
    }
    if(!state.code){ state.code=await createUniqueRoomCode(db); isHost=true; localStorage.setItem(lsKey,state.code); putCodeInUrl(state.code); }
  }
  render();

  const roomRef = doc(db,"rooms",state.code);

  const firstSnap = await getDoc(roomRef);
  if(!firstSnap.exists() && isHost){
    await setDoc(roomRef,{ hostUid:auth.currentUser.uid, status:"lobby", isPublic:false, createdAt:Date.now(), settings:{maxPlayers:state.jugadores,impostors:state.impostores,tema:state.temas[state.temaIndex], timeSec: state.tiempos[state.tiempoIndex]} },{merge:true});
  }
  if(firstSnap.exists()) isHost = firstSnap.data().hostUid === auth.currentUser.uid;
  if(isHost){ localStorage.setItem(lsKey,state.code); putCodeInUrl(state.code); }

  const myName=getStoredName(); const myAvatar=getStoredAvatar();
  meNameEl.textContent=myName;
  await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid),{ uid:auth.currentUser.uid, name:myName, avatarKey:myAvatar||null, slot:isHost?1:Date.now(), online:true },{merge:true});
  const playerRef = doc(db,"rooms",state.code,"players",auth.currentUser.uid);
  document.getElementById("editName")?.addEventListener("click", ()=> editAndSaveName(playerRef));

  function setArrowsEnabled(en){ document.querySelectorAll(".arrow").forEach(b=>{ b.style.pointerEvents=en?"auto":"none"; b.style.opacity=en?"1":".55"; }); }
  setArrowsEnabled(isHost);

  function setHostControlsVisible(on){
    leaveBtn.style.display = on ? "inline-block" : "none";
    deleteRoomBtn.style.display = on ? "inline-block" : "none";
  }
  setHostControlsVisible(isHost);

  document.querySelectorAll(".arrow").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const inc=btn.dataset.inc, dec=btn.dataset.dec;
      if(inc==="impostores") state.impostores=Math.min(3,state.impostores+1);
      if(dec==="impostores") state.impostores=Math.max(1,state.impostores-1);
      if(inc==="jugadores") state.jugadores=Math.min(10,state.jugadores+1);
      if(dec==="jugadores") state.jugadores=Math.max(4,state.jugadores-1);
      if(inc==="tema") state.temaIndex=(state.temaIndex+1)%state.temas.length;
      if(dec==="tema") state.temaIndex=(state.temaIndex-1+state.temas.length)%state.temas.length;
      if(inc==="tiempo") state.tiempoIndex = (state.tiempoIndex+1) % state.tiempos.length;
      if(dec==="tiempo") state.tiempoIndex = (state.tiempoIndex-1+state.tiempos.length) % state.tiempos.length;

      if(state.impostores>=state.jugadores) state.impostores=Math.max(1,state.jugadores-1);
      state.jugadores=Math.max(state.jugadores,lastPlayers.length);
      render();

      if(isHost){ 
        await setDoc(roomRef,{ 
          settings:{
            maxPlayers:state.jugadores,
            impostors: state.impostores,
            tema:      state.temas[state.temaIndex],
            timeSec:   state.tiempos[state.tiempoIndex]
          } 
        },{merge:true}); 
      }
    });
  });

  /* ======= SNAPSHOT PRINCIPAL (ajusta host, settings, privacidad) ======= */
  let roomSettings = null; // cache de settings para fallback
  onSnapshot(roomRef,s=>{
    if(!s.exists()) return;
    const data=s.data();

    // host
    const before=isHost; isHost=(data.hostUid===auth.currentUser.uid);
    hostUid = data.hostUid || null; // <<< NUEVO: guardamos host uid
    if(before!==isHost){ setArrowsEnabled(isHost); setHostControlsVisible(isHost); }

    // settings
    roomSettings = data.settings || roomSettings;
    const st=data.settings||{};
    state.jugadores=st.maxPlayers??state.jugadores;
    state.impostores=st.impostors??state.impostores;
    if(st.tema){ const idx=state.temas.indexOf(st.tema); state.temaIndex = idx>=0?idx:0; }
    if(st.timeSec){ const tidx = state.tiempos.indexOf(st.timeSec); state.tiempoIndex = tidx>=0 ? tidx : state.tiempoIndex; }

    // privacidad
    isPublic = !!data.isPublic;
    updatePrivacyUI();
    updateCodeVisibility();

    render();
  });

  onSnapshot(collection(db,"rooms",state.code,"players"), snap=>{ lastPlayers=snap.docs.map(d=>d.data()); drawPlayers(state.jugadores,lastPlayers); });

  /* ======= SOLICITUDES DE UNIÓN (solo host) ======= */
  onSnapshot(collection(db, "rooms", state.code, "requests"), snap=>{
    if(!isHost) return;
    snap.docChanges().forEach(async change=>{
      if(change.type === "added"){
        const req = change.doc.data();
        const ok = confirm(`${req.name || "Jugador"} quiere unirse a la sala. ¿Aceptar?`);
        try{
          if(ok){
            await setDoc(doc(db,"rooms",state.code,"players",req.uid),{
              uid:req.uid,
              name:req.name || "Jugador",
              avatarKey:req.avatarKey||null,
              online:true,
              slot:Date.now()
            },{merge:true});
          }
        }finally{
          try{ await deleteDoc(change.doc.ref); }catch{}
        }
      }
    });
  });

  const POOLS={ 
    Clubes:["Real Madrid","Barcelona","Boca Juniors","River Plate","PSG","Manchester City","Inter","AC Milan","Liverpool","Chelsea"], 
    Jugadores:["Lionel Messi","Cristiano Ronaldo","Diego Maradona","Pelé","Kylian Mbappé","Erling Haaland","Neymar","Zinedine Zidane","Ronaldinho","Ronaldo Nazário"], 
    Mundiales:["Mundial 2002","Mundial 2006","Mundial 2010","Mundial 2014","Mundial 2018","Mundial 2022"] 
  };

  function pickWord(tema){ const pool=POOLS[tema]||["Balón"]; return pool[Math.floor(Math.random()*pool.length)]; }
  function shuffleInPlace(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  // START
  let starting=false;
  document.getElementById("startBtn").addEventListener("click", async ()=>{
    if(!isHost){ alert("Solo el host puede iniciar"); return; }
    if(starting) return; starting=true;
    try{
      const roomSnap=await getDoc(roomRef);
      if(!roomSnap.exists()){ alert("Sala no encontrada."); starting=false; return; }
      const room=roomSnap.data(); const st=room.settings||{};
      if(room.status==="playing"){ alert("La partida ya está en curso."); starting=false; return; }
      const ps=await getDocs(collection(db,"rooms",state.code,"players"));
      const players=ps.docs.map(d=>({id:d.id,...d.data()})).filter(p=>p.id&&p.online!==false);
      const K=st.impostors||1; const tema=st.tema||"Clubes";
      const timeSec = st.timeSec || state.tiempos[state.tiempoIndex];
      if(players.length<3){ alert("Se necesitan al menos 3 jugadores."); starting=false; return; }
      if(K>=players.length){ alert("Impostores debe ser menor que jugadores."); starting=false; return; }
      const palabra=pickWord(tema);
      const order=shuffleInPlace(players.map(p=>p.id));
      const impostorIds=new Set(order.slice(0,K));
      const nextRound=(room.round||0)+1;
      const batch=writeBatch(db);
      batch.update(roomRef,{status:"playing",round:nextRound,startedAt:serverTimestamp(), settings:{...st, timeSec}});
      players.forEach(p=>{
        const aRef=doc(db,"rooms",state.code,"assignments",p.id);
        batch.set(aRef,{round:nextRound,uid:p.id,name:p.name||"Jugador",avatarKey:p.avatarKey||null,role:impostorIds.has(p.id)?"IMPOSTOR":"CIVIL",word:impostorIds.has(p.id)?null:palabra,tema,alive:true,vote:null,revealedAt:null});
      });
      const roundRef=doc(db,"rooms",state.code,"rounds",String(nextRound));
      batch.set(roundRef,{status:"reveal",createdAt:serverTimestamp(),order,turnIndex:0, timeSec});
      await batch.commit();
      setTimeout(async()=>{ try{ await updateDoc(roundRef,{status:"draw",drawStartedAt:serverTimestamp()}); }catch{} },10000);
    }catch(e){ console.error(e); alert(e.message||"No pude iniciar la partida."); } finally{ starting=false; }
  });

  // ABANDONAR (solo host)
  leaveBtn.addEventListener("click", async ()=>{
    if (!isHost){
      alert("Solo el host puede abandonar y resetear la sala.");
      return;
    }
    if (!confirm("¿Seguro que querés abandonar la partida actual? Esto limpia la ronda.")) return;

    try {
      const batchDel = writeBatch(db);
      const assignsSnap = await getDocs(collection(db,"rooms",state.code,"assignments"));
      assignsSnap.forEach(d => batchDel.delete(d.ref));
      const roundsSnap = await getDocs(collection(db,"rooms",state.code,"rounds"));
      roundsSnap.forEach(d => batchDel.delete(d.ref));
      await batchDel.commit();

      await updateDoc(doc(db,"rooms",state.code), {
        status: "lobby",
        round: 0,
        startedAt: null
      });

      document.getElementById("phaseDiscuss").style.display = "none";
      alert("Sesión abandonada. Ya podés iniciar otra partida.");

    } catch(e){
      console.error(e);
      alert("Error al abandonar: " + (e?.message || e));
    }
  });

  // ===== ELIMINAR SALA =====
  async function deleteCollection(collRef){
    const snap = await getDocs(collRef);
    const batchLimit = 400;
    let i = 0, batch = writeBatch(db);
    for (const d of snap.docs){
      batch.delete(d.ref);
      i++;
      if(i % batchLimit === 0){ await batch.commit(); batch = writeBatch(db); }
    }
    if(i % batchLimit !== 0) await batch.commit();
  }

  async function deleteRoomDeep(){
    if(!isHost){ alert("Solo el host puede eliminar la sala."); return; }
    const ok = confirm("⚠️ Esto eliminará la SALA completa (jugadores, rondas, chat, votos). ¿Continuar?");
    if(!ok) return;

    try{
      await deleteCollection(collection(db,"rooms",state.code,"assignments"));
      const roundsSnap = await getDocs(collection(db,"rooms",state.code,"rounds"));
      for(const rdoc of roundsSnap.docs){
        const rid = rdoc.id;
        await deleteCollection(collection(db,"rooms",state.code,"rounds",rid,"chat"));
        await deleteCollection(collection(db,"rooms",state.code,"rounds",rid,"firstWords"));
        await deleteCollection(collection(db,"rooms",state.code,"rounds",rid,"votes"));
        await deleteDoc(rdoc.ref);
      }
      await deleteCollection(collection(db,"rooms",state.code,"players"));
      await deleteCollection(collection(db,"rooms",state.code,"requests"));
      await deleteDoc(doc(db,"rooms",state.code));

      localStorage.removeItem("lastRoomCode");
      location.replace("/index.html");

    }catch(e){
      console.error(e);
      alert("Error al eliminar la sala: " + (e?.message || e));
    }
  }
  deleteRoomBtn.addEventListener("click", deleteRoomDeep);

  // Overlay rol
  onSnapshot(doc(db,"rooms",state.code,"assignments",auth.currentUser.uid), s=>{
    if(!s.exists()) return;
    const a=s.data(); const overlay=document.getElementById("reveal"); const box=document.getElementById("revContent");
    let avatarHtml=""; if(a.avatarKey && AVATAR_MAP[a.avatarKey]) avatarHtml=`<div class="rev-avatar"><img src="${AVATAR_MAP[a.avatarKey]}" alt="${a.name||'avatar'}"></div>`;
    const nameHtml=`<div class="rev-name">${a.name||"Jugador"}</div>`;
    overlay.style.display="grid";
    if(a.role==="IMPOSTOR"){ box.innerHTML=`${avatarHtml}${nameHtml}<div style="font-size:clamp(24px,7vw,38px);font-weight:900;color:#ff6b6b;margin:6px 0 8px">IMPOSTOR</div><div style="opacity:.85">Tu objetivo es camuflarte. No conocés la palabra.</div>`; }
    else{ box.innerHTML=`${avatarHtml}${nameHtml}<div style="opacity:.75;font-size:clamp(12px,3.8vw,14px);margin:6px 0">Palabra secreta (${a.tema})</div><div style="font-size:clamp(22px,7vw,34px);font-weight:900;color:#7cf062">${a.word}</div>`; }
    let secs=10; const countdownEl=document.getElementById("countdown");
    countdownEl.textContent=`Pasando en ${secs}s...`; const interval=setInterval(()=>{ secs--; countdownEl.textContent=`Pasando en ${secs}s...`; if(secs<=0){ clearInterval(interval); overlay.style.display="none"; } },1000);
  });

  // Utils
  function sanitize(str){ return (str||"").replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])); }
  async function nameOf(uid){ try{ const snap=await getDoc(doc(db,"rooms",state.code,"players",uid)); return (snap.exists()&&(snap.data().name||"Jugador"))||"Jugador"; }catch{ return "Jugador"; } }
  const timerEl = document.getElementById("timer");
  function toMillis(ts){ return ts?.toMillis?.() ?? (ts?.seconds ? ts.seconds*1000 : (typeof ts==="number" ? ts : 0)); }
  function fmtClock(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }

  // Sorteo animación
  async function startDrawAnimation(order){
    const draw=document.getElementById("drawOverlay"); const slip=document.getElementById("slip"); const list=document.getElementById("orderList");
    list.innerHTML=""; draw.style.display="grid";
    const names=await Promise.all(order.map(uid=>nameOf(uid)));
    names.forEach((n,i)=>{ const item=document.createElement("div"); item.className="order-item"; item.innerHTML=`<div class="order-badge">${i+1}</div><div class="order-name" id="ord-${i}">—</div>`; list.appendChild(item); });
    for(let i=0;i<order.length;i++){ const n=names[i]; slip.textContent=n; slip.classList.remove("reveal"); void slip.offsetWidth; slip.classList.add("reveal"); await new Promise(r=>setTimeout(r,900)); const slot=document.getElementById(`ord-${i}`); if(slot) slot.textContent=n; await new Promise(r=>setTimeout(r,450)); }
    const roomSnap=await getDoc(roomRef); const roundId=String(roomSnap.data().round||0);
    if(isHost && roundId!=="0"){ await updateDoc(doc(db,"rooms",state.code,"rounds",roundId),{status:"prompt",promptStartedAt:serverTimestamp(),turnIndex:0}); }
    setTimeout(()=>{ draw.style.display="none"; },600);
  }

  // === RESULTADOS / SIGUIENTE RONDA ===
  async function tallyVotes(roundId){
    const votesSnap = await getDocs(collection(db,"rooms",state.code,"rounds",String(roundId),"votes"));
    const counts = new Map();
    for (const d of votesSnap.docs){
      const v = d.data()?.target;
      if(!v) continue;
      counts.set(v, (counts.get(v)||0)+1);
    }
    if(counts.size===0) return { expelledUid:null, tie:false, counts:{} };

    let max = 0, winners = [];
    for (const [uid,c] of counts){
      if (c>max){ winners=[uid]; max=c; }
      else if (c===max){ winners.push(uid); }
    }
    const tie = winners.length!==1;
    const expelledUid = tie ? null : winners[0];

    const countsObj = {};
    for (const [k,v] of counts) countsObj[k]=v;
    return { expelledUid, tie, counts:countsObj, max };
  }

  async function getAssignment(uid){
    try{
      const a = await getDoc(doc(db,"rooms",state.code,"assignments",uid));
      return a.exists()? a.data() : null;
    }catch{ return null; }
  }

  function showResultsOverlayUI({ title, subtitle, color="#cfe4ff" }){
    const ov = document.getElementById("resultsOverlay");
    const box = document.getElementById("resultsBox");
    const sub = document.getElementById("resultsSub");
    box.innerHTML = `<div style="font-weight:900;font-size:clamp(20px,6.5vw,28px);color:${color}">${title}</div>`;
    sub.textContent = subtitle || "";
    ov.style.display = "grid";
  }
  function hideResultsOverlayUI(){ document.getElementById("resultsOverlay").style.display="none"; }

  async function startNextRoundKeepingRoles(){
    const roomSnap = await getDoc(roomRef);
    const room = roomSnap.data()||{};
    const st = room.settings || roomSettings || {};
    const tema = st.tema || state.temas[state.temaIndex];
    const timeSec = st.timeSec || state.tiempos[state.tiempoIndex];

    const asgSnap = await getDocs(collection(db,"rooms",state.code,"assignments"));
    const all = asgSnap.docs.map(d=>d.data());
    const alive = all.filter(p => p.alive!==false);

    if (alive.length < 3){
      showResultsOverlayUI({
        title: "No hay suficientes jugadores vivos para continuar",
        subtitle: "Volvé al lobby y creá una nueva partida.",
        color:"#ffd166"
      });
      return;
    }

    const order = shuffleInPlace(alive.map(p=>p.uid));
    const palabra = pickWord(tema);
    const nextRound = (room.round||0) + 1;

    const batch = writeBatch(db);
    batch.update(roomRef,{ round: nextRound, status: "playing", startedAt: serverTimestamp(), settings:{...st, timeSec} });

    for (const p of all){
      const ref = doc(db,"rooms",state.code,"assignments",p.uid);
      const word = (p.alive!==false && p.role!=="IMPOSTOR") ? palabra : null;
      batch.set(ref,{ ...p, round: nextRound, word, tema, revealedAt:null, vote:null }, { merge:true });
    }

    const roundRef = doc(db,"rooms",state.code,"rounds",String(nextRound));
    batch.set(roundRef,{ status:"reveal", createdAt: serverTimestamp(), order, turnIndex:0, timeSec });

    await batch.commit();
    setTimeout(async()=>{ try{ await updateDoc(roundRef,{ status:"draw", drawStartedAt: serverTimestamp() }); }catch{} }, 10000);
  }

  // Estado de ronda
  let currentRound=0;
  let roundState=null;
  let drawPlayedForRound=0;

  let unsubscribeRoundHint=null;
  let unsubscribeChat=null;
  let unsubscribeFirstWords=null;
  let unsubscribeRoundPhase=null;

  let _turnBannerTimer=null;
  function showTurnBanner(name){
    const banner=document.getElementById("turnBanner");
    const who=document.getElementById("turnName");
    who.textContent=name||"alguien";
    banner.classList.remove("hide"); banner.classList.add("show"); banner.style.display="block";
    if(_turnBannerTimer) clearTimeout(_turnBannerTimer);
    _turnBannerTimer=setTimeout(()=>{ banner.classList.remove("show"); banner.classList.add("hide"); setTimeout(()=>{ banner.style.display="none"; },350); },2200);
  }

  let firstWordsMap = new Set();
  function subscribeFirstWords(roundId){
    if(unsubscribeFirstWords) unsubscribeFirstWords();
    firstWordsMap = new Set();
    unsubscribeFirstWords = onSnapshot(
      collection(db,"rooms",state.code,"rounds",String(roundId),"firstWords"),
      snap=>{
        firstWordsMap = new Set(snap.docs.map(d=>d.id));
        advanceIfReadyByHost();
      }
    );
  }

  async function advanceIfReadyByHost(){
    if(!isHost || !roundState || roundState.status!=="prompt") return;
    const order = roundState.order || [];
    const idx   = roundState.turnIndex ?? 0;
    const uidTurno = order[idx];
    if(!uidTurno) return;
    if(firstWordsMap.has(uidTurno)){
      const roundId = String(currentRound);
      const nextIdx = idx + 1;
      if(nextIdx < order.length){
        try{ await updateDoc(doc(db,"rooms",state.code,"rounds",roundId),{turnIndex:nextIdx}); }catch(e){ console.warn(e); }
      }else{
        const tSec = roundState?.timeSec || roomSettings?.timeSec || state.tiempos[state.tiempoIndex];
        try{ await updateDoc(doc(db,"rooms",state.code,"rounds",roundId),{status:"discuss",discussStartedAt:serverTimestamp(), timeSec: tSec}); }catch(e){ console.warn(e); }
      }
    }
  }

  let discussTicker = null;
  const timerBox = document.getElementById("timer");
  function startDiscussCountdown(roundDocData, isHostNow){
    if(discussTicker) { clearInterval(discussTicker); discussTicker=null; }
    const startMs = toMillis(roundDocData?.discussStartedAt);
    const totalSec = roundDocData?.timeSec || roomSettings?.timeSec || state.tiempos[state.tiempoIndex];
    const totalMs = (totalSec||60)*1000;
    if(!startMs){ timerBox.textContent=""; return; }

    discussTicker = setInterval(async ()=>{
      const now = Date.now();
      const left = (startMs + totalMs) - now;
      timerBox.textContent = fmtClock(left);

      if(left <= 0){
        clearInterval(discussTicker); discussTicker=null;
        timerBox.textContent = "00:00";
        if(isHostNow){
          try{
            const roomSnap = await getDoc(roomRef);
            const roundId = String(roomSnap.data().round||0);
            await updateDoc(doc(db,"rooms",state.code,"rounds",roundId),{
              status:"vote",
              voteStartedAt: serverTimestamp()
            });
          }catch(e){ console.warn(e); }
        }
      }
    }, 250);
  }

  function subscribeChat(roundId){
    if(unsubscribeChat) unsubscribeChat();
    let lastByUid = new Map();

    unsubscribeChat = onSnapshot(
      collection(db,"rooms",state.code,"rounds",String(roundId),"chat"),
      async snap=>{
        const items = snap.docs
          .map(d=>({ _doc:d, id:d.id, ...d.data() }))
          .sort((a,b)=>(a.at?.seconds||0)-(b.at?.seconds||0));

        if(isHost && roundState?.status==="discuss"){
          for(const m of items){
            if(m.kind!=="chat") continue;
            const prev = lastByUid.get(m.uid)||0;
            const t = toMillis(m.at);
            if(prev && (t - prev) < 3000){
              try{ await deleteDoc(m._doc.ref); }catch(e){ console.warn("No pude borrar msg rápido", e); }
              continue;
            }
            lastByUid.set(m.uid, t);
          }
        }

        ui.chatList.innerHTML = items.map(m=>{
          const mine = m.uid === (auth.currentUser && auth.currentUser.uid);
          return `<div class="chat-row ${mine?'mine':'other'}"><div class="bubble"><div class="name">${sanitize(m.name)||"Jugador"}</div><div class="text">${sanitize(m.text||"")}</div></div></div>`;
        }).join("");
        ui.chatList.scrollTop = ui.chatList.scrollHeight;
      }
    );
  }

  function subscribeRoundPhase(roundId){
    if (unsubscribeRoundPhase) unsubscribeRoundPhase();

    const rRef = doc(db,"rooms",state.code,"rounds",String(roundId));
    unsubscribeRoundPhase = onSnapshot(rRef, async (rdoc)=>{
      if(!rdoc.exists()) return;

      roundState = rdoc.data();
      const phase = roundState.status;
      const discussPanel = document.getElementById("phaseDiscuss");

      if(phase==="reveal"){
        discussPanel.style.display="none";
      }

      if(phase==="results"){
        document.getElementById("phaseDiscuss").style.display="block";
        ui.turnHint.textContent = "Resultados";
        timerBox.textContent = "";

        const rRef2 = doc(db,"rooms",state.code,"rounds",String(currentRound));
        const roundId2 = String(currentRound);

        if(isHost && !roundState.resultsComputed){
          try{
            const { expelledUid, tie, counts } = await tallyVotes(roundId2);
            await updateDoc(rRef2, { resultsComputed: true, expelledUid: expelledUid || null, tie: !!tie, counts });
            if(expelledUid){
              await updateDoc(doc(db,"rooms",state.code,"assignments",expelledUid), { alive:false });
            }
          }catch(e){ console.warn("Error al computar resultados:", e); }
        }

        setTimeout(async ()=>{
          try{
            const rDoc = await getDoc(rRef2);
            const rData = rDoc.data()||{};
            const tie = !!rData.tie;
            const expelledUid = rData.expelledUid || null;

            if(tie || !expelledUid){
              showResultsOverlayUI({
                title: "Empate — Nadie fue expulsado",
                subtitle: "Se jugará otra ronda con nueva palabra.",
                color: "#ffd166"
              });
            }else{
              const asg = await getAssignment(expelledUid);
              const nombre = asg?.name || "Jugador";
              const rol = asg?.role || "—";
              showResultsOverlayUI({
                title: `Eliminado: ${nombre}`,
                subtitle: `Rol: ${rol}`,
                color: rol==="IMPOSTOR" ? "#ff6b6b" : "#cfe4ff"
              });
            }
          }catch(e){ console.warn(e); }
        }, 250);

        setTimeout(async ()=>{
          hideResultsOverlayUI();
          if(isHost){
            try{ await startNextRoundKeepingRoles(); }catch(e){ console.warn(e); }
          }
        }, 6000);
      }

      if(phase==="draw"){
        discussPanel.style.display="none";
        if(drawPlayedForRound!==roundId){
          drawPlayedForRound=roundId;
          startDrawAnimation(roundState.order||[]);
        }
      }

      if(phase==="prompt"){
        discussPanel.style.display="block";
        document.getElementById("firstWordTip").style.display="none"; /* oculto tip si no lo usás */
        ui.chatInput.placeholder="Primero UNA palabra (2–24 letras)…";
        const idx=roundState.turnIndex??0;
        const uidTurno=(roundState.order||[])[idx];
        ui.turnHint.textContent = uidTurno ? `Turno de: ${await nameOf(uidTurno)}` : "";
        timerBox.textContent = "";
      }

      if(phase==="discuss"){
        discussPanel.style.display="block";
        document.getElementById("firstWordTip").style.display="none";
        ui.turnHint.textContent="Chat libre";
        ui.chatInput.placeholder="Decí tu pista/suspecha (3s cooldown)";
        startDiscussCountdown(roundState, isHost);
      }

      if(phase==="vote"){
        discussPanel.style.display="block";
        ui.turnHint.textContent="Votación";
        timerBox.textContent = "";
        renderVoteBar();
      }
    });
  }

  // Detectar cambio de ronda desde rooms y enganchar suscripciones de la ronda
  onSnapshot(roomRef, async s=>{
    if(!s.exists()) return;
    const data = s.data();
    const newRound = data.round || 0;

    if(newRound && newRound !== currentRound){
      currentRound = newRound;
      subscribeChat(currentRound);
      subscribeFirstWords(currentRound);
      subscribeRoundPhase(currentRound);
    }else{
      currentRound = newRound;
    }
  });

  // Fallbacks de fase (host)
  onSnapshot(roomRef, async (snap)=>{
    if(!snap.exists()||!isHost) return;
    const data=snap.data(); const rId=data.round||0; if(!rId) return;
    const rRef=doc(db,"rooms",state.code,"rounds",String(rId)); const rDoc=await getDoc(rRef); if(!rDoc.exists()) return;
    const r=rDoc.data();
    const toMs=(ts)=>ts?.toMillis?.()??(ts?.seconds?ts.seconds*1000:(typeof ts==="number"?ts:0));
    const now=Date.now(), createdMs=toMs(r.createdAt), drawMs=toMs(r.drawStartedAt);
    if(r.status==="reveal" && createdMs && now-createdMs>11000) { try{ await updateDoc(rRef,{status:"draw",drawStartedAt:serverTimestamp()}); }catch{} }
    if(r.status==="draw" && drawMs && now-drawMs>20000) { try{ await updateDoc(rRef,{status:"prompt",promptStartedAt:serverTimestamp(),turnIndex:0}); }catch{} }
  });

  // UI chat
  const ui={
    chatForm:document.getElementById("chatForm"),
    chatInput:document.getElementById("chatInput"),
    chatList:document.getElementById("chatList"),
    voteBar:document.getElementById("voteBar"),
    cooldownHint:document.getElementById("cooldownHint"),
    turnHint:document.getElementById("turnHint"),
  };

  let cooldownUntil=0;
  function canSendNow(){
    const now=Date.now();
    if(roundState?.status==="prompt") return true;
    if(now<cooldownUntil){ const left=Math.ceil((cooldownUntil-now)/1000); ui.cooldownHint.textContent=`Esperá ${left}s para volver a enviar`; return false; }
    ui.cooldownHint.textContent=""; return true;
  }
  function isOneWordLatin(str){ return /^\p{L}{2,24}$/u.test(str); }
  function showError(msg){
    ui.cooldownHint.textContent=msg; ui.cooldownHint.style.color="#ff7b7b";
    ui.chatInput.style.outline="2px solid #ff7b7b";
    setTimeout(()=>{ ui.cooldownHint.style.color=""; ui.chatInput.style.outline=""; },1800);
  }

  document.getElementById("chatForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!roundState) { showError("No hay ronda activa."); return; }
    const raw=(ui.chatInput.value||"").trim(); if(!raw) return;
    const myUid=auth.currentUser?.uid;
    const roundId=String(currentRound);

    try{
      if(roundState.status==="prompt"){
        const idx=roundState.turnIndex??0; const order=roundState.order||[]; const uidTurno=order[idx];

        if(!myUid || !uidTurno || String(myUid)!==String(uidTurno)){
          const name = uidTurno ? await nameOf(uidTurno) : "alguien";
          showError(`Esperá tu turno. Ahora: ${name}.`); return;
        }
        if(!isOneWordLatin(raw)){ showError("Enviá UNA sola palabra (2–24 letras, sin espacios)."); return; }

        if(firstWordsMap.has(myUid)){ showError("Ya enviaste tu palabra. Esperá que avance el turno."); return; }

        await setDoc(doc(db,"rooms",state.code,"rounds",roundId,"firstWords",myUid),{
          uid:myUid, name:getStoredName(), text:raw, at:serverTimestamp()
        });
        const msgRef=doc(collection(db,"rooms",state.code,"rounds",roundId,"chat"));
        await setDoc(msgRef,{ uid:myUid, name:getStoredName(), text:raw, at:serverTimestamp(), kind:"firstword" });
        ui.chatInput.value="";
        return;
      }

      if(roundState.status==="discuss"){
        if(!canSendNow()) return;
        const msgRef=doc(collection(db,"rooms",state.code,"rounds",roundId,"chat"));
        await setDoc(msgRef,{ uid:myUid, name:getStoredName(), text:raw, at:serverTimestamp(), kind:"chat" });
        ui.chatInput.value=""; cooldownUntil=Date.now()+3000; canSendNow(); return;
      }

      showError("No podés enviar ahora.");

    }catch(e){
      console.error(e);
      showError(`Error al enviar: ${e?.message||e}`);
    }
  });

  // Votación
  async function renderVoteBar(){
    const asgSnap=await getDocs(collection(db,"rooms",state.code,"assignments"));
    const players=asgSnap.docs.map(d=>d.data()).filter(p=>p.alive!==false);
    document.getElementById("voteBar").innerHTML = players.map(p=>{
  const src=(p.avatarKey && AVATAR_MAP[p.avatarKey])?AVATAR_MAP[p.avatarKey]:"";
  return `<button class="btn vote-item" data-vote="${p.uid}">
    <span class="vote-avatar">
      ${src?`<img src="${src}" style="width:100%;height:100%;object-fit:cover">`:`${icon("i-ball")}`}
    </span>
    ${sanitize(p.name)||"Jugador"}
  </button>`;
}).join("");

    document.querySelectorAll("[data-vote]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const votedUid=btn.getAttribute("data-vote");
        const roomSnap=await getDoc(roomRef); const roundId=roomSnap.data().round||0;
        const myVoteRef=doc(db,"rooms",state.code,"rounds",String(roundId),"votes",auth.currentUser.uid);
        try{ await setDoc(myVoteRef,{ voter:auth.currentUser.uid, target:votedUid, at:serverTimestamp() }); document.querySelectorAll("[data-vote]").forEach(b=>b.style.opacity=".6"); btn.style.opacity="1"; }catch(e){ console.warn(e); }
      });
    });
  }

  // Cierre auto de votación cuando todos votan
  onSnapshot(roomRef, async s=>{
    if(!s.exists()) return;
    const data = s.data();
    const roundId = data.round || 0;

    onSnapshot(collection(db,"rooms",state.code,"rounds",String(roundId),"votes"), async snap=>{
      const voted = new Set(snap.docs.map(d=>d.id));
      const asgSnap = await getDocs(collection(db,"rooms",state.code,"assignments"));
      const aliveVoters = asgSnap.docs
        .map(d=>d.data())
        .filter(p => p.alive !== false)
        .map(p => p.uid)
        .filter(Boolean);

      if (isHost && aliveVoters.length > 0 && aliveVoters.every(id => voted.has(id))){
        await updateDoc(doc(db,"rooms",state.code,"rounds",String(roundId)),{
          status:"results",
          resultsAt: serverTimestamp()
        });
      }
    });
  });

  document.getElementById("copyBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(state.code); showToast("Código copiado"); }
  catch{ showToast("No pude copiar"); }
});


  document.getElementById("shareBtn").addEventListener("click", async ()=>{
    const joinUrl=`${location.origin}/ingresar.html?code=${state.code}`;
    if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`Código ${state.code}`, url:joinUrl}); }catch{} }
    else { try{ await navigator.clipboard.writeText(joinUrl); showToast("🔗 Enlace copiado"); }catch{ alert(joinUrl); } }
  });

  </script>
  </div>
  <script>
(function(){
  // 5 segundos mínimo
  const MIN_LOADING_MS = 5000;

  const overlay = document.getElementById('loader-overlay');
  const app = document.getElementById('app-wrapper');
  const start = window.__loaderStart || performance.now();

  function finishLoading(){
    overlay.classList.add('hidden');
    app.classList.remove('hidden');
    setTimeout(()=>{ overlay?.parentNode?.removeChild(overlay); }, 500);
  }

  // Espera a que termine de cargar + cumplir los 5s
  window.addEventListener('load', () => {
    const elapsed = performance.now() - start;
    const remaining = Math.max(0, MIN_LOADING_MS - elapsed);
    setTimeout(finishLoading, remaining);
  });

  // Fallback por si 'load' no dispara
  setTimeout(() => {
    if (!overlay.classList.contains('hidden')) finishLoading();
  }, 10000);
})();
</script>
</body>
</html>
