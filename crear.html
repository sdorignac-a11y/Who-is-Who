<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Impostor F√∫tbol ‚Äì Lobby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --panel:#0f2b4b;--panel-2:#0c213a;--yellow:#f6c11b;--yellow-2:#f39c12;--text:#eaf2ff;--muted:#a7c0e8;
    --space:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:"Outfit",system-ui; color:var(--text);
    background: url("fondo-cancha.png") center/cover no-repeat fixed;
    min-height:100dvh;
    padding: calc(env(safe-area-inset-top,0px) + 8px) calc(env(safe-area-inset-right,0px) + 8px) calc(env(safe-area-inset-bottom,0px) + 8px) calc(env(safe-area-inset-left,0px) + 8px);
  }
  .container{width:min(1200px,96vw);margin:0 auto;display:flex;flex-direction:column;gap:18px}
  .room-card{background:linear-gradient(180deg,rgba(7,28,56,.9),rgba(8,33,63,.88));border:1.5px solid rgba(128,180,255,.25);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);padding:16px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .ball{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle,#fff 0 48%,transparent 50%),conic-gradient(#111 0 60deg,#fff 0 120deg,#111 0 180deg,#fff 0 240deg,#111 0 300deg,#fff 0 360deg);box-shadow:0 0 14px rgba(255,255,255,.35)}
  .brand h1{margin:0;letter-spacing:.5px;line-height:1;font-size:clamp(20px,4.8vw,28px);font-weight:800;text-transform:uppercase;text-shadow:0 3px 0 rgba(0,0,0,.5)}
  .brand h1 span{color:#7cf062}
  .code-box{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .room-code{font-size:clamp(22px,7vw,36px);font-weight:800;letter-spacing:2px}
  .btn{background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700;padding:10px 14px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);cursor:pointer;font-size:clamp(12px,3.6vw,14px)}
  .user-area{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .userbox{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:8px 10px;font-weight:700;color:#cfe4ff}
  .mini-btn{padding:6px 10px;border-radius:10px;cursor:pointer;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700}
  .players{display:grid;grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));gap:12px;padding:0 4px}
  .player{background:linear-gradient(180deg,rgba(14,39,70,.9),rgba(10,30,53,.85));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:108px}
  .avatar{width:56px;height:56px;border-radius:50%;background:radial-gradient(36px 24px at 50% 30%,#ffd6b4 0 60%,#e9b089 61% 100%),radial-gradient(80px 40px at 50% 105%,#222 0 60%,transparent 61%),linear-gradient(180deg,#e23a3a,#a61e1e);display:grid;place-items:center;overflow:hidden}
  .avatar.placeholder{background:radial-gradient(28px 28px at 50% 40%,#2f4b73 0 60%,#203a5e 61% 100%),radial-gradient(48px 48px at 50% 110%,#162b4a 0 58%,transparent 59%)}
  .avatar-img{width:100%;height:100%;object-fit:cover;display:block}
  .settings{display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:clamp(14px,3.8vw,16px);letter-spacing:.3px;color:#cce0ff;text-transform:uppercase;font-weight:800}
  .selector{display:flex;align-items:center;justify-content:space-between;gap:8px;background:linear-gradient(180deg,#0b2441,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px}
  .selector .value{font-size:clamp(20px,6.5vw,28px);font-weight:800}
  .selector .arrow{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;cursor:pointer;font-size:20px;font-weight:900}
  .cta{display:flex;justify-content:center;flex-wrap:wrap;gap:12px;margin-top: clamp(24px, 5.5vh, 80px)}
  .btn-cta{background:linear-gradient(180deg,var(--yellow),var(--yellow-2));border:1px solid rgba(255,210,80,.9);color:#10223b;font-weight:900;font-size:clamp(18px,6.5vw,28px);padding:14px 24px;border-radius:16px}
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(20px);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.35);color:#eaf2ff;padding:10px 14px;border-radius:12px;z-index:2000;opacity:0;pointer-events:none;box-shadow:0 12px 28px rgba(0,0,0,.45);transition:opacity .22s ease, transform .22s ease;font-weight:800}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .lobby-layout{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .chat-card{height:100%;background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:16px;display:flex;flex-direction:column;min-height:420px}
  .chat-head{padding:12px 14px;border-bottom:1px solid rgba(128,180,255,.18)}
  .chat-list{flex:1;overflow:auto;padding:12px 12px 6px}
  .chat-form{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(128,180,255,.18)}
  .chat-form input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(128,180,255,.35);background:#0a213b;color:#eaf2ff;font-size:14px}
  .msg-row{display:flex;margin:6px 0}
  .msg{max-width:88%;padding:8px 12px;border-radius:12px;background:#142946;border:1px solid rgba(128,180,255,.18);color:#cfe4ff;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .msg.mine{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-color:rgba(255,255,255,.2);margin-left:auto}
  @media (max-width:900px){.lobby-layout{grid-template-columns:1fr}.user-area{align-items:center}.room-card{grid-template-columns:1fr;gap:12px;text-align:center}}
</style>
</head>
<body>
  <div class="container">
    <div class="room-card">
      <div class="brand"><div class="ball"></div><h1>Impostor <span>F√∫tbol</span></h1></div>
      <div class="code-box">
        <strong style="opacity:.7">C√ìDIGO:</strong>
        <div class="room-code" id="roomCode">‚Äî</div>
        <button id="toggleCodeBtn" class="btn">üëÅÔ∏è Mostrar c√≥digo</button>
        <button id="copyBtn" class="btn">Copiar</button>
      </div>
      <div class="user-area">
        <div class="userbox">
          <span id="meName">‚Äî</span>
          <button id="editName" class="mini-btn">Editar</button>
        </div>
        <button id="shareBtn" class="btn">Compartir enlace</button>
      </div>
    </div>

    <div class="lobby-layout">
      <main>
        <div class="players" id="players"></div>
        <div class="settings">
          <div class="card">
            <h3>Impostores</h3>
            <div class="selector">
              <div class="arrow" data-dec="impostores">‚Äπ</div>
              <div class="value" id="impostoresVal">1</div>
              <div class="arrow" data-inc="impostores">‚Ä∫</div>
            </div>
          </div>
          <div class="card">
            <h3>Jugadores</h3>
            <div class="selector">
              <div class="arrow" data-dec="jugadores">‚Äπ</div>
              <div class="value" id="jugadoresVal">8</div>
              <div class="arrow" data-inc="jugadores">‚Ä∫</div>
            </div>
          </div>
          <div class="card">
            <h3>Tema</h3>
            <div class="selector">
              <div class="arrow" data-dec="tema">‚Äπ</div>
              <div class="value" id="temaVal">Clubes</div>
              <div class="arrow" data-inc="tema">‚Ä∫</div>
            </div>
          </div>
          <div class="card">
            <h3>Tiempo</h3>
            <div class="selector">
              <div class="arrow" data-dec="tiempo">‚Äπ</div>
              <div class="value" id="tiempoVal">60s</div>
              <div class="arrow" data-inc="tiempo">‚Ä∫</div>
            </div>
          </div>
          <div class="card">
            <h3>Privacidad</h3>
            <div class="selector" style="justify-content:center">
              <button id="togglePrivacyBtn" class="btn">Privada</button>
              <small id="privacyHint" style="opacity:.8;font-weight:700">Solo con c√≥digo</small>
            </div>
          </div>
        </div>
        <div class="cta">
          <button id="startBtn" class="btn-cta">EMPEZAR PARTIDA</button>
          <button id="leaveBtn" class="btn" style="display:none">ABANDONAR PARTIDA</button>
          <button id="deleteRoomBtn" class="btn" style="display:none;background:linear-gradient(180deg,#ea4335,#c92e21);border-color:#ffb3ac">ELIMINAR SALA</button>
        </div>
      </main>
      <aside>
        <div class="chat-card">
          <div class="chat-head"><h3>Chat de la sala</h3></div>
          <div id="lobbyChatList" class="chat-list"></div>
          <form id="lobbyChatForm" class="chat-form">
            <input id="lobbyChatInput" maxlength="180" placeholder="Escrib√≠ un mensaje‚Ä¶">
            <button class="btn" type="submit">Enviar</button>
          </form>
        </div>
      </aside>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyAegeue7A8qFFW4IScFFgtvT4P1g2GLkCM",
  authDomain: "who-is-who-6ea99.firebaseapp.com",
  projectId: "who-is-who-6ea99",
  storageBucket: "who-is-who-6ea99.firebasestorage.app",
  messagingSenderId: "718537140049",
  appId: "1:718537140049:web:7400ec7e5467b387f8d570",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await setPersistence(auth, browserLocalPersistence);

// ===== Helpers =====
const $ = s => document.querySelector(s);
const roomCodeEl = $("#roomCode");
const meNameEl = $("#meName");
const playersWrap = $("#players");
const toggleCodeBtn = $("#toggleCodeBtn");
const copyBtn = $("#copyBtn");
const shareBtn = $("#shareBtn");
const togglePrivacyBtn = $("#togglePrivacyBtn");
const privacyHint = $("#privacyHint");
const leaveBtn = $("#leaveBtn");
const deleteRoomBtn = $("#deleteRoomBtn");

function showToast(msg, ms=1400){
  const t = $("#toast");
  t.textContent = msg; t.classList.add("show");
  clearTimeout(showToast._h); showToast._h = setTimeout(()=> t.classList.remove("show"), ms);
}
function genCode(len=6){ const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<len;i++) s+=A[Math.floor(Math.random()*A.length)]; return s; }
async function uniqueCode(tries=10){
  for(let i=0;i<tries;i++){ const c=genCode(6); const ref=doc(db,"rooms",c); if(!(await getDoc(ref)).exists()) return c; }
  return genCode(8);
}
function sanitize(s){ return String(s||"").replace(/[<>]/g, ""); }

// Avatares (placeholder seguro)
const AVATAR_MAP = { cristiano:"avatars/cristiano.png", lamine:"avatars/lamine.png", odegar:"avatars/odegar.png", ronaldinho:"avatars/ronaldinho.png", ronaldo:"avatars/ronaldo.png" };
function normalizeAvatarKey(k){ const key=(k||"").toLowerCase(); return AVATAR_MAP[key] ? key : ""; }

// ===== Estado UI =====
const impostoresEl = $("#impostoresVal");
const jugadoresEl  = $("#jugadoresVal");
const temaEl       = $("#temaVal");
const tiempoEl     = $("#tiempoVal");
let isHost = false; let showCode=false; let isPublic=false; let roomRef; let hostUid=null; let lastPlayers=[];
const state={ code:"", impostores:1, jugadores:8, temas:["Clubes","Jugadores","Mundiales"], temaIndex:0, tiempos:[30,45,60,90,120], tiempoIndex:2 };

function render(){
  roomCodeEl.textContent = showCode ? (state.code || "‚Äî") : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
  impostoresEl.textContent = state.impostores;
  jugadoresEl.textContent  = state.jugadores;
  temaEl.textContent       = state.temas[state.temaIndex];
  tiempoEl.textContent     = state.tiempos[state.tiempoIndex] + "s";
  drawPlayers(state.jugadores, lastPlayers);
}
function drawPlayers(maxCount, list){
  const meUid = auth.currentUser?.uid;
  const ordered = (list||[]).slice().sort((a,b)=>{
    if(a.uid===hostUid && b.uid!==hostUid) return -1;
    if(b.uid===hostUid && a.uid!==hostUid) return 1;
    if(a.uid===meUid   && b.uid!==meUid)   return -1;
    if(b.uid===meUid   && a.uid!==meUid)   return 1;
    return (a.slot||0)-(b.slot||0);
  });
  playersWrap.innerHTML = ordered.map(p=>{
    const isMe = p.uid===meUid; const hasAv = p.avatarKey && AVATAR_MAP[p.avatarKey];
    return `<div class="player"><div class="avatar ${hasAv?"":"placeholder"}">${hasAv?`<img class="avatar-img" src="${AVATAR_MAP[p.avatarKey]}" alt="avatar">`:``}</div><small>${sanitize(p.name||"Jugador")} ${isMe?`<span style='color:#ffd166;font-weight:900'>(yo)</span>`:''}</small></div>`;
  }).join("");
  if(ordered.length < maxCount){
    const btn = document.createElement("button");
    btn.className = "player btn"; btn.innerHTML = `<small>Invitar</small>`;
    btn.onclick = async ()=>{
      const url = `${location.origin}/ingresar.html?code=${state.code}`;
      if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`C√≥digo ${state.code}`, url}); }catch{} }
      else { try{ await navigator.clipboard.writeText(url); showToast("üîó Enlace copiado"); }catch{ alert(url); } }
    };
    playersWrap.appendChild(btn);
  }
}
function setArrowsEnabled(en){ document.querySelectorAll(".arrow").forEach(b=>{ b.style.pointerEvents=en?"auto":"none"; b.style.opacity=en?"1":".55"; }); }
function updatePrivacyUI(){
  togglePrivacyBtn.textContent = isPublic ? "P√∫blica" : "Privada";
  privacyHint.textContent = isPublic ? "Aparece en listado p√∫blico" : "Solo con c√≥digo";
  togglePrivacyBtn.style.background = isPublic ? "linear-gradient(180deg,#22c55e,#16a34a)" : "linear-gradient(180deg,#1e68d6,#184fa5)";
}
function updateCodeVisibility(){ roomCodeEl.textContent = showCode ? (state.code||"‚Äî") : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"; toggleCodeBtn.textContent = showCode?"üôà Ocultar c√≥digo":"üëÅÔ∏è Mostrar c√≥digo"; }

// ===== Auth y room boot =====
async function ensureAuth(){
  const user = await new Promise(res=>{ const off = onAuthStateChanged(auth,u=>{ off(); res(u); }); });
  return user || (await signInAnonymously(auth)).user;
}
const user = await ensureAuth();

// Decidir si crear sala o unirse por ?code=
const lsKey = "lastRoomCode";
const urlCode = new URLSearchParams(location.search).get("code");
if(urlCode && urlCode.trim()){
  state.code = urlCode.trim().toUpperCase();
  isHost = false;
}else{
  const prev = localStorage.getItem(lsKey);
  if(prev){
    const prevSnap = await getDoc(doc(db,"rooms",prev));
    if(prevSnap.exists()){
      state.code = prev; isHost = (prevSnap.data().hostUid===user.uid);
    }
  }
  if(!state.code){ state.code = await uniqueCode(); isHost = true; localStorage.setItem(lsKey,state.code); }
}
roomRef = doc(db,"rooms",state.code);

// Crear sala si soy host
const firstSnap = await getDoc(roomRef);
if(!firstSnap.exists() && isHost){
  await setDoc(roomRef,{
    hostUid:user.uid, status:"lobby", isPublic:false, createdAt:Date.now(),
    settings:{ maxPlayers:state.jugadores, impostors:state.impostores, tema:state.temas[state.temaIndex], timeSec:state.tiempos[state.tiempoIndex] }
  },{merge:true});
}
// Si existe, recalcular isHost por si entr√© por URL
if(firstSnap.exists()) isHost = (firstSnap.data().hostUid===user.uid);
if(isHost) localStorage.setItem(lsKey,state.code);

// Guardar/leer nombre & avatar locales
function getStoredName(){ const s = localStorage.getItem("displayName")||""; return (s.trim().length>=2 && s.trim().length<=16) ? s.trim() : "Jugador"; }
function getStoredAvatar(){ const saved = normalizeAvatarKey(localStorage.getItem("avatarKey")); return saved || ""; }
const myName = getStoredName(); const myAvatar = getStoredAvatar(); meNameEl.textContent = myName;

// Almacenar/actualizar mi player doc
const playerRef = doc(db,"rooms",state.code,"players",user.uid);
await setDoc(playerRef,{ uid:user.uid, name:myName, avatarKey:myAvatar||null, slot:isHost?1:Date.now(), online:true },{merge:true});

// Editar nombre in-place
$("#editName").addEventListener("click", async ()=>{
  const prev = getStoredName();
  const nuevo = prompt("Tu nombre para mostrar (2‚Äì16 chars):", prev) ?? "";
  const v = nuevo.trim(); if(v.length<2 || v.length>16) return;
  localStorage.setItem("displayName", v); meNameEl.textContent = v;
  try{ await updateDoc(playerRef, { name:v }); }catch{}
});

// Flechas de settings (solo host)
setArrowsEnabled(isHost);
document.querySelectorAll(".arrow").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const inc=btn.dataset.inc, dec=btn.dataset.dec;
    if(inc==="impostores") state.impostores=Math.min(3,state.impostores+1);
    if(dec==="impostores") state.impostores=Math.max(1,state.impostores-1);
    if(inc==="jugadores") state.jugadores=Math.min(10,state.jugadores+1);
    if(dec==="jugadores") state.jugadores=Math.max(4,state.jugadores-1);
    if(inc==="tema") state.temaIndex=(state.temaIndex+1)%state.temas.length;
    if(dec==="tema") state.temaIndex=(state.temaIndex-1+state.temas.length)%state.temas.length;
    if(inc==="tiempo") state.tiempoIndex=(state.tiempoIndex+1)%state.tiempos.length;
    if(dec==="tiempo") state.tiempoIndex=(state.tiempoIndex-1+state.tiempos.length)%state.tiempos.length;
    if(state.impostores>=state.jugadores) state.impostores=Math.max(1,state.jugadores-1);
    state.jugadores=Math.max(state.jugadores,lastPlayers.length);
    render();
    if(isHost){ await setDoc(roomRef,{ settings:{ maxPlayers:state.jugadores, impostors:state.impostores, tema:state.temas[state.temaIndex], timeSec:state.tiempos[state.tiempoIndex] } },{merge:true}); }
  });
});

// Mostrar/ocultar c√≥digo + copiar + compartir
updateCodeVisibility();
toggleCodeBtn.addEventListener("click", ()=>{ showCode=!showCode; updateCodeVisibility(); });
copyBtn.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(state.code); showToast("üî¢ C√≥digo copiado"); }catch{} });
shareBtn.addEventListener("click", async ()=>{
  const joinUrl=`${location.origin}/ingresar.html?code=${state.code}`;
  if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`C√≥digo ${state.code}`, url:joinUrl}); }catch{} }
  else { try{ await navigator.clipboard.writeText(joinUrl); showToast("üîó Enlace copiado"); }catch{ alert(joinUrl); } }
});

// Toggle privacidad (solo host)
function setHostControlsVisible(on){ leaveBtn.style.display = on?"inline-block":"none"; deleteRoomBtn.style.display = on?"inline-block":"none"; }
setHostControlsVisible(isHost);
updatePrivacyUI();

togglePrivacyBtn.addEventListener("click", async ()=>{
  if(!isHost){ alert("Solo el host puede cambiar esto."); return; }
  isPublic = !isPublic; updatePrivacyUI();
  try{ await updateDoc(roomRef,{ isPublic }); }catch(e){ console.warn(e); }
});

// ===== Snapshots =====
// Sala (host + settings + privacidad)
let roomSettings = null;
onSnapshot(roomRef, s=>{
  if(!s.exists()) return;
  const data = s.data();
  const was = isHost; isHost = (data.hostUid===user.uid); if(was!==isHost){ setArrowsEnabled(isHost); setHostControlsVisible(isHost); }
  hostUid = data.hostUid || null;
  roomSettings = data.settings || roomSettings;
  const st = data.settings || {};
  state.jugadores = st.maxPlayers ?? state.jugadores;
  state.impostores= st.impostors  ?? state.impostores;
  if(st.tema){ const idx=state.temas.indexOf(st.tema); state.temaIndex = idx>=0?idx:0; }
  if(st.timeSec){ const tidx=state.tiempos.indexOf(st.timeSec); state.tiempoIndex = tidx>=0?tidx:state.tiempoIndex; }
  isPublic = !!data.isPublic; updatePrivacyUI();
  render();
});
// Jugadores
onSnapshot(collection(db,"rooms",state.code,"players"), snap=>{
  lastPlayers = snap.docs.map(d=>d.data());
  drawPlayers(state.jugadores,lastPlayers);
});

// ===== Chat de lobby =====
const lobbyChatList = $("#lobbyChatList");
const lobbyChatForm = $("#lobbyChatForm");
const lobbyChatInput = $("#lobbyChatInput");

onSnapshot(collection(db,"rooms",state.code,"lobbyChat"), snap=>{
  lobbyChatList.innerHTML = "";
  snap.docChanges ? snap.forEach(()=>{}) : null; // compat
  snap.forEach(docu=>{
    const m = docu.data();
    const row = document.createElement("div"); row.className = "msg-row";
    const mine = m.uid===user.uid; const bubble = document.createElement("div"); bubble.className = `msg ${mine?"mine":""}`;
    bubble.innerHTML = `<div class='name' style='font-weight:800;opacity:.85;font-size:12px'>${sanitize(m.name||"Jugador")}</div><div>${sanitize(m.text||"")}</div>`;
    row.appendChild(bubble); lobbyChatList.appendChild(row);
  });
  lobbyChatList.scrollTop = lobbyChatList.scrollHeight;
});

lobbyChatForm.addEventListener("submit", async (e)=>{
  e.preventDefault(); const text = lobbyChatInput.value.trim(); if(!text) return;
  lobbyChatInput.value="";
  try{ await addDoc(collection(db,"rooms",state.code,"lobbyChat"), { uid:user.uid, name:getStoredName(), text, ts:serverTimestamp() }); }catch(e){ console.warn(e); }
});

// ===== Empezar partida (asignaciones b√°sicas) =====
const startBtn = $("#startBtn");
startBtn.addEventListener("click", async ()=>{
  if(!isHost){ alert("Solo el host puede iniciar"); return; }
  const roomSnap = await getDoc(roomRef); if(!roomSnap.exists()){ alert("Sala no encontrada."); return; }
  const st = (roomSnap.data().settings)||{};
  const ps = await getDocs(collection(db,"rooms",state.code,"players"));
  const players = ps.docs.map(d=>({id:d.id,...d.data()})).filter(p=>p.id && p.online!==false);
  if(players.length<3){ alert("Se necesitan al menos 3 jugadores."); return; }
  const K = st.impostors||1; if(K>=players.length){ alert("Impostores debe ser menor que jugadores."); return; }
  const temas = state.temas; const tema = st.tema || temas[0];
  const palabraPool = { Clubes:["Boca Juniors","Real Madrid","PSG","Inter"], Jugadores:["Messi","Ronaldo","Maradona","Haaland"], Mundiales:["Mundial 2010","Mundial 2014","Mundial 2022"] };
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const palabra = pick(palabraPool[tema]||["Bal√≥n"]);
  // Orden aleatorio
  const order = players.map(p=>p.id).sort(()=>Math.random()-0.5);
  const impostorIds = new Set(order.slice(0, K));
  const nextRound = (roomSnap.data().round||0)+1;
  const batch = writeBatch(db);
  batch.set(roomRef,{ status:"playing", round:nextRound, startedAt:serverTimestamp(), settings:{...st}, orderMaster:order },{merge:true});
  for(const p of players){
    const aRef = doc(db,"rooms",state.code,"assignments",p.id);
    batch.set(aRef,{ round:nextRound, uid:p.id, name:p.name||"Jugador", avatarKey:p.avatarKey||null, role:impostorIds.has(p.id)?"IMPOSTOR":"CIVIL", word:impostorIds.has(p.id)?null:palabra, tema, alive:true, vote:null, revealedAt:null });
  }
  await batch.commit();
  showToast("üé≤ Roles asignados");
});

// ===== Peque√±os extras =====
$("#leaveBtn").addEventListener("click", async ()=>{ try{ await updateDoc(playerRef,{online:false}); location.href = "index.html"; }catch{} });
$("#deleteRoomBtn").addEventListener("click", async ()=>{
  if(!isHost) return; if(!confirm("¬øEliminar sala y todo su contenido?")) return;
  try{ await deleteDoc(roomRef); showToast("Sala eliminada"); setTimeout(()=>location.href="index.html",600); }catch(e){ alert("No se pudo eliminar"); }
});

// Primer render
render();
</script>
</body>
</html>
