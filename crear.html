<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impostor FÃºtbol â€“ Lobby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--panel:#0f2b4b;--panel-2:#0c213a;--yellow:#f6c11b;--yellow-2:#f39c12;--text:#eaf2ff;--muted:#a7c0e8}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Outfit",system-ui;color:var(--text);background:url("fondo-cancha.png") center/cover fixed no-repeat;overflow:hidden}
  .container{width:min(1200px,92vw);margin:0 auto;padding:20px 0 28px;display:flex;flex-direction:column;gap:18px}
  .room-card{background:linear-gradient(180deg,rgba(7,28,56,.9),rgba(8,33,63,.88));border:1.5px solid rgba(128,180,255,.25);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);padding:16px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .ball{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle,#fff 0 48%,transparent 50%),conic-gradient(#111 0 60deg,#fff 0 120deg,#111 0 180deg,#fff 0 240deg,#111 0 300deg,#fff 0 360deg);box-shadow:0 0 14px rgba(255,255,255,.35)}
  .brand h1{margin:0;letter-spacing:.5px;line-height:1;font-size:28px;font-weight:800;text-transform:uppercase;text-shadow:0 3px 0 rgba(0,0,0,.5)}
  .brand h1 span{color:#7cf062}
  .code-box{background:linear-gradient(180deg,#0c2747,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:center}
  .room-code{font-size:36px;font-weight:800;letter-spacing:2px}
  .btn{background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.65);color:#eaf2ff;font-weight:700;padding:12px 16px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);cursor:pointer}
  .players{display:grid;grid-template-columns:repeat(8,1fr);gap:16px;padding:0 4px}
  .player{background:linear-gradient(180deg,rgba(14,39,70,.9),rgba(10,30,53,.85));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:108px}
  .avatar{width:56px;height:56px;border-radius:50%;background:radial-gradient(36px 24px at 50% 30%,#ffd6b4 0 60%,#e9b089 61% 100%),radial-gradient(80px 40px at 50% 105%,#222 0 60%,transparent 61%),linear-gradient(180deg,#e23a3a,#a61e1e)}
  .avatar.placeholder{background:radial-gradient(28px 28px at 50% 40%,#2f4b73 0 60%,#203a5e 61% 100%),radial-gradient(48px 48px at 50% 110%,#162b4a 0 58%,transparent 59%)}
  .player small{color:var(--muted);font-weight:600}
  .settings{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(128,180,255,.25);border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:16px;letter-spacing:.3px;color:#cce0ff;text-transform:uppercase;font-weight:800}
  .selector{display:flex;align-items:center;justify-content:space-between;gap:8px;background:linear-gradient(180deg,#0b2441,#0a213b);border:1px solid rgba(128,180,255,.28);border-radius:12px;padding:10px}
  .selector .value{font-size:28px;font-weight:800}
  .selector .arrow{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1e68d6,#184fa5);border:1px solid rgba(110,178,255,.7);display:grid;place-items:center;cursor:pointer;font-size:20px;font-weight:900}
  .cta{display:flex;justify-content:center}
  .btn-cta{background:linear-gradient(180deg,var(--yellow),var(--yellow-2));border:1px solid rgba(255,210,80,.9);color:#10223b;font-weight:900;font-size:28px;padding:16px 34px;border-radius:16px}
  #reveal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,10,20,.9)}
  .rev-card{width:min(680px,92vw);background:linear-gradient(180deg,#0d2747,#0b203a);border:1px solid rgba(128,180,255,.3);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:24px;text-align:center}
  .rev-content{padding:18px;background:linear-gradient(180deg,#102c4f,#0c2441);border:1px solid rgba(128,180,255,.25);border-radius:16px;min-height:110px;display:grid;place-items:center;font-size:26px;font-weight:800}
</style>
</head>
<body>
  <div class="container">
    <div class="room-card">
      <div class="brand"><div class="ball"></div><h1>Impostor <span>FÃºtbol</span></h1></div>
      <div class="code-box"><strong style="opacity:.7">CÃ“DIGO:</strong><div class="room-code" id="roomCode">TCZLPQ</div><button id="copyBtn" class="btn">Copiar</button></div>
      <div><button id="shareBtn" class="btn">Compartir enlace</button></div>
    </div>

    <div class="players" id="players"></div>

    <div class="settings">
      <div class="card"><h3>Impostores</h3><div class="selector"><div class="arrow" data-dec="impostores">â€¹</div><div class="value" id="impostoresVal">1</div><div class="arrow" data-inc="impostores">â€º</div></div></div>
      <div class="card"><h3>Jugadores</h3><div class="selector"><div class="arrow" data-dec="jugadores">â€¹</div><div class="value" id="jugadoresVal">8</div><div class="arrow" data-inc="jugadores">â€º</div></div></div>
      <div class="card"><h3>Tema</h3><div class="selector"><div class="arrow" data-dec="tema">â€¹</div><div class="value" id="temaVal">Clubes</div><div class="arrow" data-inc="tema">â€º</div></div></div>
    </div>

    <div class="cta"><button id="startBtn" class="btn-cta">EMPEZAR PARTIDA</button></div>
  </div>

  <!-- Overlay: cada jugador ve su propio rol -->
  <div id="reveal">
    <div class="rev-card">
      <h2>Tu rol</h2>
      <div id="revContent" class="rev-content"></div>
      <div style="margin-top:12px">
        <button id="btnComenzarRonda" class="btn-cta">ðŸš€ Comenzar ronda</button>
      </div>
    </div>
  </div>

<script type="module">
  // ---- UI local ----
  const state = { code:"TCZLPQ", impostores:1, jugadores:8, temas:["Clubes","Jugadores","Mundiales"], temaIndex:0 };
  const $ = s=>document.querySelector(s);
  const roomCodeEl=$("#roomCode"), playersWrap=$("#players");
  function renderPlayers(n){ playersWrap.innerHTML=""; for(let i=1;i<=n;i++){ const d=document.createElement("div"); d.className="player"; const a=document.createElement("div"); a.className="avatar placeholder"; const t=document.createElement("small"); t.textContent=`Jugador ${i}`; d.append(a,t); playersWrap.append(d);} }
  function render(){ $("#impostoresVal").textContent=state.impostores; $("#jugadoresVal").textContent=state.jugadores; $("#temaVal").textContent=state.temas[state.temaIndex]; roomCodeEl.textContent=state.code; renderPlayers(state.jugadores); }
  render();
  document.querySelectorAll(".arrow").forEach(b=>b.addEventListener("click",()=>{const i=b.dataset.inc,d=b.dataset.dec;if(i==="impostores")state.impostores=Math.min(3,state.impostores+1); if(d==="impostores")state.impostores=Math.max(1,state.impostores-1); if(i==="jugadores")state.jugadores=Math.min(10,state.jugadores+1); if(d==="jugadores")state.jugadores=Math.max(4,state.jugadores-1); if(i==="tema")state.temaIndex=(state.temaIndex+1)%state.temas.length; if(d==="tema")state.temaIndex=(state.temaIndex-1+state.temas.length)%state.temas.length; if(state.impostores>=state.jugadores)state.impostores=Math.max(1,state.jugadores-1); render(); }));

  // ---- Firebase ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyAegeue7A8qFFW4IScFFgtvT4P1g2GLkCM",
    authDomain: "who-is-who-6ea99.firebaseapp.com",
    projectId: "who-is-who-6ea99",
    storageBucket: "who-is-who-6ea99.firebasestorage.app",
    messagingSenderId: "718537140049",
    appId: "1:718537140049:web:7400ec7e5467b387f8d570"
  });
  const auth = getAuth(app);
  const db = getFirestore(app);
  await signInAnonymously(auth);

  // host si NO hay ?code=, invitado si hay ?code=
  const urlCode = new URLSearchParams(location.search).get("code");
  const isHost = !urlCode;
  state.code = (urlCode || state.code).toUpperCase();
  roomCodeEl.textContent = state.code;

  const roomRef = doc(db,"rooms",state.code);

  // pools
  const POOLS = {
    Clubes:["Real Madrid","Barcelona","Boca Juniors","River Plate","PSG","Manchester City","Inter","AC Milan","Liverpool","Chelsea"],
    Jugadores:["Lionel Messi","Cristiano Ronaldo","Diego Maradona","PelÃ©","Kylian MbappÃ©","Erling Haaland","Neymar","Zinedine Zidane","Ronaldinho","Ronaldo NazÃ¡rio"],
    Mundiales:["Mundial 2002","Mundial 2006","Mundial 2010","Mundial 2014","Mundial 2018","Mundial 2022"]
  };
  const r = n=>Math.floor(Math.random()*n), sample = a=>a[r(a.length)], shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=r(i+1);[a[i],a[j]]=[a[j],a[i]]}return a};

  // crear/entrar sala
  if(isHost){
    await setDoc(roomRef, {
      hostUid: auth.currentUser.uid,
      status: "lobby",
      createdAt: Date.now(),
      settings: { maxPlayers: state.jugadores, impostors: state.impostores, tema: state.temas[state.temaIndex] }
    }, { merge:true });

    await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid),
      { uid:auth.currentUser.uid, name:"Jugador 1", slot:1, online:true }, { merge:true });

  }else{
    const snap = await getDoc(roomRef);
    if(!snap.exists()){ alert("La sala no existe"); location.href="index.html"; }
    const s = snap.data().settings;
    state.jugadores=s.maxPlayers; state.impostores=s.impostors; state.temaIndex=["Clubes","Jugadores","Mundiales"].indexOf(s.tema); if(state.temaIndex<0)state.temaIndex=0; render();
    await setDoc(doc(db,"rooms",state.code,"players",auth.currentUser.uid),
      { uid:auth.currentUser.uid, name:"Jugador", slot:Date.now(), online:true }, { merge:true });
    // invitados no editan settings
    document.querySelectorAll(".arrow").forEach(b=>b.style.pointerEvents="none");
  }

  // reflejar settings en vivo
  onSnapshot(roomRef, s=>{
    if(!s.exists()) return;
    const st=s.data().settings;
    state.jugadores=st.maxPlayers; state.impostores=st.impostors; $("#temaVal").textContent=st.tema; renderPlayers(state.jugadores);
  });

  // si host cambia flechas -> guarda
  if(isHost){
    document.querySelectorAll(".arrow").forEach(b=>b.addEventListener("click", async ()=>{
      await updateDoc(roomRef, { settings:{ maxPlayers:state.jugadores, impostors:state.impostores, tema:state.temas[state.temaIndex] }});
    }));
  }

  // lista de jugadores en vivo
  onSnapshot(collection(db,"rooms",state.code,"players"), s=>{
    const players=s.docs.map(d=>d.data()).sort((a,b)=>(a.slot||0)-(b.slot||0));
    playersWrap.innerHTML="";
    for(let i=0;i<state.jugadores;i++){
      const p=players[i];
      const d=document.createElement("div"); d.className="player";
      const a=document.createElement("div"); a.className=p?"avatar":"avatar placeholder";
      const t=document.createElement("small"); t.textContent=p?(p.name||`Jugador ${i+1}`):`Jugador ${i+1}`;
      d.append(a,t); playersWrap.append(d);
    }
  });

  // empezar partida -> asignaciones
  document.getElementById("startBtn").addEventListener("click", async ()=>{
    if(!isHost){ alert("Solo el host puede iniciar"); return; }
    const rs = (await getDoc(roomRef)).data(); const tema = rs.settings.tema; const K = rs.settings.impostors;
    const ps = await getDocs(collection(db,"rooms",state.code,"players"));
    const players = ps.docs.map(d=>d.data());
    if(K >= players.length){ alert("Impostores debe ser menor que jugadores"); return; }
    const palabra = sample(POOLS[tema] || ["BalÃ³n"]);
    const imp = new Set(shuffle([...players]).slice(0,K).map(p=>p.uid));
    const batch = writeBatch(db);
    players.forEach(p=>{
      batch.set(doc(db,"rooms",state.code,"assignments",p.uid), { role: imp.has(p.uid)?"IMPOSTOR":"CIVIL", word: imp.has(p.uid)?null:palabra, tema });
    });
    batch.update(roomRef, { status:"playing" });
    await batch.commit();
  });

  // cada jugador escucha su assignment y ve su rol
  onSnapshot(doc(db,"rooms",state.code,"assignments",auth.currentUser.uid), s=>{
    if(!s.exists()) return;
    const a=s.data(); const overlay=$("#reveal"), box=$("#revContent"); overlay.style.display="grid";
    if(a.role==="IMPOSTOR"){
      box.innerHTML=`<div><div style="font-size:38px;font-weight:900;color:#ff6b6b;margin-bottom:8px">IMPOSTOR</div><div style="opacity:.85">Tu objetivo es camuflarte. No conocÃ©s la palabra.</div></div>`;
    }else{
      box.innerHTML=`<div><div style="opacity:.75;font-size:14px;margin-bottom:6px">Palabra secreta (${a.tema})</div><div style="font-size:34px;font-weight:900;color:#7cf062">${a.word}</div></div>`;
    }
  });

  document.getElementById("btnComenzarRonda").addEventListener("click", ()=>{
    document.getElementById("reveal").style.display="none";
    // aquÃ­ podrÃ­as ir a ronda.html
    // location.href = "ronda.html?code="+state.code;
  });

  // copiar/compartir
  document.getElementById("copyBtn").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(state.code); }catch{}
  });
  document.getElementById("shareBtn").addEventListener("click", async ()=>{
    const url = `${location.origin}${location.pathname.replace("crear.html","ingresar.html")}`;
    const full = `${url}?code=${state.code}`;
    if(navigator.share){ try{ await navigator.share({title:"Unite a mi sala", text:`CÃ³digo ${state.code}`, url:full}); }catch{} }
    else{ try{ await navigator.clipboard.writeText(full); alert("Enlace copiado"); }catch{ alert(full); } }
  });
</script>
</body>
</html>
